<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>METIER_COFAH_COMPTA - Rapport 2 : Delais de traitement</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
            background-color: #4a5568;
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar gauche */
        .sidebar {
            width: 220px;
            background-color: #f5f5f5;
            border-right: 1px solid #ccc;
            padding: 10px 0;
        }

        .sidebar-item {
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-item:hover {
            background-color: #e8e8e8;
        }

        .sidebar-item.parent {
            font-weight: bold;
            cursor: pointer;
            user-select: none;
        }

        .sidebar-item.parent:hover {
            background-color: #ddd;
        }

        .sidebar-item.parent .expand {
            display: inline-block;
            width: 12px;
            text-align: center;
            transition: transform 0.2s;
        }

        .submenu {
            overflow: hidden;
        }

        .sidebar-item .icon {
            width: 16px;
            height: 16px;
            display: inline-block;
        }

        .sidebar-item .expand {
            font-size: 10px;
            color: #666;
        }

        /* Indicateurs de couleur */
        .color-box {
            width: 14px;
            height: 14px;
            display: inline-block;
            border: 1px solid #999;
        }

        .color-red { background-color: #dc2626; }
        .color-yellow { background-color: #f59e0b; }
        .color-orange { background-color: #ea580c; }
        .color-green { background-color: #22c55e; }

        .checkbox {
            width: 14px;
            height: 14px;
            border: 1px solid #666;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: white;
            cursor: pointer;
        }

        .checkbox.checked::after {
            content: "\2714";
            font-size: 10px;
            color: #333;
        }

        /* Zone principale */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #f5f0e1;
        }

        /* Barre de menu */
        .menu-bar {
            background: linear-gradient(to bottom, #ff6b35, #e55a2b);
            padding: 8px 15px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .menu-item {
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .menu-item:hover {
            text-decoration: underline;
        }

        .menu-item .arrow {
            font-size: 8px;
        }

        .collapse-btn {
            background: #666;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Titre section */
        .section-title {
            padding: 15px 20px;
            font-size: 14px;
            color: #333;
        }

        /* Container graphique */
        .chart-container {
            padding: 20px;
            background: white;
            margin: 0 20px 20px 20px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .chart-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .chart-title {
            font-size: 14px;
            font-weight: bold;
            color: #f59e0b;
            background-color: #f59e0b;
            color: white;
            padding: 5px 10px;
            display: inline-block;
        }

        .filters {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            color: #333;
            font-weight: 500;
        }

        .filter-group select {
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
            background-color: white;
            cursor: pointer;
        }

        .filter-group select:hover {
            border-color: #999;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #ff6b35;
        }

        /* Graphique barres */
        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 300px;
            padding: 20px 10px;
            border-left: 2px solid #ccc;
            border-bottom: 2px solid #ccc;
            position: relative;
            margin-top: 30px;
        }

        /* Echelle Y */
        .y-axis {
            position: absolute;
            left: -35px;
            top: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
        }

        .bar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 60px;
        }

        .bar {
            width: 45px;
            background-color: #5b7c99;
            border-radius: 3px 3px 0 0;
            position: relative;
            transition: background-color 0.3s;
        }

        .bar:hover {
            background-color: #4a6a85;
        }

        .bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: bold;
            color: #333;
        }

        .bar-label {
            margin-top: 10px;
            font-size: 10px;
            color: #666;
            text-align: center;
            transform: rotate(-45deg);
            white-space: nowrap;
        }

        .chart-description {
            margin-top: 30px;
            font-style: italic;
            color: #333;
            font-size: 13px;
            line-height: 1.5;
        }

        /* Barres cliquables */
        .bar {
            cursor: pointer;
        }

        .bar.selected {
            background-color: #ff6b35 !important;
        }

        /* Tableau detail */
        .detail-container {
            margin-top: 30px;
            display: none;
        }

        .detail-container.visible {
            display: block;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .detail-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            background-color: #5b7c99;
            color: white;
            padding: 5px 10px;
            display: inline-block;
        }

        .close-detail {
            background: #dc2626;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .close-detail:hover {
            background: #b91c1c;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .detail-table th {
            background-color: #e8e4d9;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #ccc;
            color: #333;
        }

        .detail-table td {
            padding: 8px;
            border: 1px solid #ddd;
            color: #333;
        }

        .detail-table tr:nth-child(even) {
            background-color: #fafafa;
        }

        .detail-table tr:hover {
            background-color: #f0f0f0;
        }

        .delai-court {
            color: #22c55e;
            font-weight: bold;
        }

        .delai-moyen {
            color: #f59e0b;
            font-weight: bold;
        }

        .delai-long {
            color: #dc2626;
            font-weight: bold;
        }

        /* Accordion styles */
        .accordion-row {
            cursor: pointer;
            background-color: #f8f9fa !important;
        }

        .accordion-row:hover {
            background-color: #e9ecef !important;
        }

        .accordion-row td:first-child {
            position: relative;
            padding-left: 25px;
        }

        .accordion-icon {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            transition: transform 0.2s;
        }

        .accordion-row.expanded .accordion-icon {
            transform: translateY(-50%) rotate(90deg);
        }

        .task-row {
            display: none;
            background-color: #fff !important;
        }

        .task-row.visible {
            display: table-row;
        }

        .task-row td:first-child {
            padding-left: 40px;
            font-size: 11px;
            color: #666;
        }

        .stat-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }

        .stat-badge.count {
            background-color: #e0e7ff;
            color: #3730a3;
        }

        .user-name {
            font-weight: 600;
        }

        .stats-cell {
            font-size: 11px;
        }

        .legend-container {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 11px;
            color: #666;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-dot.green { background-color: #22c55e; }
        .legend-dot.orange { background-color: #f59e0b; }
        .legend-dot.red { background-color: #dc2626; }

        /* Task row clickable */
        .task-row {
            cursor: pointer;
        }

        .task-row:hover {
            background-color: #e3f2fd !important;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(to bottom, #ff6b35, #e55a2b);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #5b7c99;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #5b7c99;
        }

        .modal-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .modal-field {
            display: flex;
            flex-direction: column;
        }

        .modal-field-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .modal-field-value {
            font-size: 13px;
            color: #333;
            font-weight: 500;
            padding: 8px 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #5b7c99;
        }

        .modal-field-value.highlight {
            background-color: #fff3cd;
            border-left-color: #f59e0b;
        }

        .modal-field-value.success {
            background-color: #d4edda;
            border-left-color: #22c55e;
        }

        .modal-field-value.danger {
            background-color: #f8d7da;
            border-left-color: #dc2626;
        }

        .modal-field.full-width {
            grid-column: span 3;
        }

        .modal-field.half-width {
            grid-column: span 2;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-badge.traite {
            background-color: #ea580c;
            color: white;
        }
    </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
    <!-- ADC_FINANCE -->
    <div class="sidebar-item parent" onclick="toggleSidebarMenu('menu-adc-finance', this)">
        <span class="expand">></span>
        <span class="checkbox"></span>
        ADC_FINANCE
    </div>
    <div id="menu-adc-finance" class="submenu" style="display: none;">
        <div class="sidebar-item" style="padding-left: 35px;">
            <span class="checkbox"></span>
            <span class="color-box color-red"></span>
            Encours
        </div>
        <div class="sidebar-item" style="padding-left: 35px;">
            <span class="checkbox"></span>
            <span class="color-box color-yellow"></span>
            Valide
        </div>
        <div class="sidebar-item" style="padding-left: 35px;">
            <span class="checkbox"></span>
            <span class="color-box color-green"></span>
            Termine
        </div>
    </div>

    <!-- METIER_COFAH_COMPTA -->
    <div class="sidebar-item parent" onclick="toggleSidebarMenu('menu-cofah-compta', this)">
        <span class="expand">v</span>
        <span class="checkbox"></span>
        METIER_COFAH_COMPTA
    </div>
    <div id="menu-cofah-compta" class="submenu" style="display: block;">
        <div class="sidebar-item" style="padding-left: 35px;">
            <span class="checkbox"></span>
            <span class="color-box color-red"></span>
            Ouverture
        </div>
        <div class="sidebar-item" style="padding-left: 35px;">
            <span class="checkbox"></span>
            <span class="color-box color-yellow"></span>
            Cree
        </div>
        <div class="sidebar-item" style="padding-left: 35px;">
            <span class="checkbox"></span>
            <span class="color-box color-orange"></span>
            A Traiter
        </div>
        <div class="sidebar-item" style="padding-left: 35px;">
            <span class="checkbox checked"></span>
            <span class="color-box color-orange"></span>
            Traite
        </div>
        <div class="sidebar-item" style="padding-left: 35px;">
            <span class="checkbox"></span>
            <span class="color-box color-green"></span>
            Cloture
        </div>
    </div>

    <!-- METIERS -->
    <div class="sidebar-item parent" style="margin-top: 10px;" onclick="toggleSidebarMenu('menu-metiers', this)">
        <span class="expand">></span>
        METIERS
    </div>
    <div id="menu-metiers" class="submenu" style="display: none;">
        <div class="sidebar-item" style="padding-left: 35px;">
            <span class="checkbox"></span>
            <span class="color-box color-red"></span>
            Ouverture
        </div>
        <div class="sidebar-item" style="padding-left: 35px;">
            <span class="checkbox"></span>
            <span class="color-box color-yellow"></span>
            Cree
        </div>
        <div class="sidebar-item" style="padding-left: 35px;">
            <span class="checkbox"></span>
            <span class="color-box color-orange"></span>
            A Traiter
        </div>
        <div class="sidebar-item" style="padding-left: 35px;">
            <span class="checkbox"></span>
            <span class="color-box color-orange"></span>
            Traite
        </div>
        <div class="sidebar-item" style="padding-left: 35px;">
            <span class="checkbox"></span>
            <span class="color-box color-green"></span>
            Cloture
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="main-content">

    <!-- Menu Bar -->
    <div class="menu-bar">
        <button class="collapse-btn">&lt;</button>
        <div class="menu-item">Cas <span class="arrow">v</span></div>
        <div class="menu-item">Afficher <span class="arrow">v</span></div>
        <div class="menu-item">Exportation <span class="arrow">v</span></div>
        <div class="menu-item" onclick="openSFDModal()">Workflow Metier <span class="arrow">v</span></div>
        <div class="menu-item" onclick="openADCWorkflowModal()">Workflow ADC <span class="arrow">v</span></div>
    </div>

    <!-- Section Title -->
    <div class="section-title">
        Rapport 2 : Delais de traitement - METIER_COFAH_COMPTA sur les cas Traite
    </div>

    <!-- Chart -->
    <div class="chart-container">
        <div class="chart-header">
            <div class="chart-title">Moyenne Delais de traitement sur les Encaissements CHEQUES</div>
            <div class="filters">
                <div class="filter-group">
                    <label for="filter-annee">Annee :</label>
                    <select id="filter-annee" onchange="updateChart()">
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-mois">Mois :</label>
                    <select id="filter-mois" onchange="updateChart()">
                        <option value="tous" selected>Tous</option>
                        <option value="01">Janvier</option>
                        <option value="02">Fevrier</option>
                        <option value="03">Mars</option>
                        <option value="04">Avril</option>
                        <option value="05">Mai</option>
                        <option value="06">Juin</option>
                        <option value="07">Juillet</option>
                        <option value="08">Aout</option>
                        <option value="09">Septembre</option>
                        <option value="10">Octobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">Decembre</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="bar-chart-container" class="bar-chart">
            <div class="y-axis">
                <span>8.00</span>
                <span>6.00</span>
                <span>4.00</span>
                <span>2.00</span>
                <span>0.00</span>
            </div>
            <!-- Bars generated dynamically by JavaScript -->
        </div>

        <p class="chart-description">
            Le graphique fait ressortir, une donnee avec un nombre de jours moyen de traitement par mois.
        </p>

        <!-- Detail Table (hidden by default) -->
        <div id="detail-container" class="detail-container">
            <div class="detail-header">
                <span id="detail-title" class="detail-title">Detail des taches - Juin 2025</span>
                <button class="close-detail" onclick="hideDetail()">Fermer</button>
            </div>
            <table class="detail-table">
                <thead>
                    <tr>
                        <th>UID</th>
                        <th>Nb Taches</th>
                        <th>Delai Moyen</th>
                        <th>Delai Min</th>
                        <th>Delai Max</th>
                        <th>Service Correcteur</th>
                    </tr>
                </thead>
                <tbody id="detail-tbody">
                    <!-- Filled by JavaScript - Accordion rows -->
                </tbody>
            </table>
            <div class="legend-container">
                <div class="legend-item"><span class="legend-dot green"></span> Delai <= 3 jours</div>
                <div class="legend-item"><span class="legend-dot orange"></span> Delai 4-5 jours</div>
                <div class="legend-item"><span class="legend-dot red"></span> Delai > 5 jours</div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detail Tache -->
<div id="task-modal" class="modal-overlay" onclick="closeModalOnOverlay(event)">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modal-title">Detail de la tache - Ref: 13:32</h3>
            <button class="modal-close" onclick="closeTaskModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Section Identification -->
            <div class="modal-section">
                <div class="modal-section-title">Identification</div>
                <div class="modal-grid">
                    <div class="modal-field">
                        <span class="modal-field-label">Reference</span>
                        <span class="modal-field-value" id="modal-reference">13:32</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Etat</span>
                        <span class="modal-field-value" id="modal-etat"><span class="status-badge traite">Traite</span></span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Statut Tache</span>
                        <span class="modal-field-value" id="modal-statut">Traite</span>
                    </div>
                </div>
            </div>

            <!-- Section Dates -->
            <div class="modal-section">
                <div class="modal-section-title">Dates et Delais</div>
                <div class="modal-grid">
                    <div class="modal-field">
                        <span class="modal-field-label">Date Ouverture</span>
                        <span class="modal-field-value" id="modal-date-creation">01/06/2025</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Date Traitement</span>
                        <span class="modal-field-value" id="modal-date-traitement">10/06/2025</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Delai (jours)</span>
                        <span class="modal-field-value danger" id="modal-delai">9</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Heure du Deplacement</span>
                        <span class="modal-field-value" id="modal-heure">14:32:45</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Verrouille</span>
                        <span class="modal-field-value" id="modal-verrouille">Non</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Type Taches</span>
                        <span class="modal-field-value" id="modal-type-tache">Encaissement CHEQUE</span>
                    </div>
                </div>
            </div>

            <!-- Section Utilisateur -->
            <div class="modal-section">
                <div class="modal-section-title">Utilisateur / Service</div>
                <div class="modal-grid">
                    <div class="modal-field">
                        <span class="modal-field-label">UID</span>
                        <span class="modal-field-value highlight" id="modal-uid">j07155</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Nom</span>
                        <span class="modal-field-value" id="modal-nom">DUPONT Marie</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Service Correcteur</span>
                        <span class="modal-field-value" id="modal-service">CPTA DFAR FIAB</span>
                    </div>
                </div>
            </div>

            <!-- Section Financier -->
            <div class="modal-section">
                <div class="modal-section-title">Informations Financieres</div>
                <div class="modal-grid">
                    <div class="modal-field">
                        <span class="modal-field-label">Societe</span>
                        <span class="modal-field-value" id="modal-societe">COFAH SA</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">ISIN</span>
                        <span class="modal-field-value" id="modal-isin">FR0000120578</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Compte Bancaire</span>
                        <span class="modal-field-value" id="modal-compte">FR76 3000 4025 6700 0100 0123 456</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Montant Global</span>
                        <span class="modal-field-value highlight" id="modal-montant">12 450.00 EUR</span>
                    </div>
                    <div class="modal-field half-width">
                        <span class="modal-field-label">Libelle</span>
                        <span class="modal-field-value" id="modal-libelle">Encaissement cheque client REF-2025-0632</span>
                    </div>
                </div>
            </div>

            <!-- Section Interlocuteur -->
            <div class="modal-section">
                <div class="modal-section-title">Contact</div>
                <div class="modal-grid">
                    <div class="modal-field full-width">
                        <span class="modal-field-label">Interlocuteur</span>
                        <span class="modal-field-value" id="modal-interlocuteur">Jean-Pierre MARTIN - Direction Financiere</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal SFD - Specification Fonctionnelle Detaillee - ACCURATE WORKFLOW -->
<div id="sfd-modal" class="modal-overlay" onclick="closeSFDModalOnOverlay(event)">
    <div class="modal" style="max-width: 1200px;">
        <div class="modal-header" style="background: linear-gradient(to bottom, #5b7c99, #4a6a85);">
            <h3>SFD - ACCURATE : Workflow METIER_COFAH (GDR) / ADC_FINANCE</h3>
            <button class="modal-close" onclick="closeSFDModal()">&times;</button>
        </div>
        <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">

            <!-- Section 1: Contexte -->
            <div class="modal-section">
                <div class="modal-section-title">1. CONTEXTE ET OBJECTIF</div>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 4px;">
                    <p><strong>Application :</strong> ACCURATE</p>
                    <p><strong>Module :</strong> Workflow Metiers - Gestion des taches entre equipes</p>
                    <p><strong>Objectif fonctionnel :</strong> Permettre aux equipes <span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 3px; font-weight: bold;">METIER_COFAH (GDR)</span> de creer des taches qui seront traitees par les equipes <span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 3px; font-weight: bold;">ADC_FINANCE / COMPTA</span>, avec validation manageriale et suivi des statuts.</p>

                    <!-- Objectif principal : Delais de traitement -->
                    <div style="margin-top: 15px; padding: 15px; background: #dbeafe; border-radius: 6px; border-left: 4px solid #2563eb;">
                        <p style="margin: 0 0 10px 0; font-weight: bold; color: #1e40af; font-size: 13px;">OBJECTIF PRINCIPAL : Mesurer les delais de traitement entre equipes</p>
                        <p style="margin: 0 0 10px 0;">Ce workflow permet de <strong>suivre et analyser les delais de traitement des taches</strong> lorsqu'elles transitent entre les differentes equipes :</p>
                        <ul style="margin: 0 0 10px 20px;">
                            <li><strong>Delai de prise en charge :</strong> Temps entre la creation par METIER_COFAH et la validation par ADC Manager</li>
                            <li><strong>Delai de traitement :</strong> Temps entre l'assignation (A traiter) et le traitement effectif (Traite)</li>
                            <li><strong>Delai de correction :</strong> Temps de retour apres un rejet (boucle Traitement non valide)</li>
                            <li><strong>Delai total :</strong> Temps entre l'ouverture et la cloture de la tache</li>
                        </ul>
                        <p style="margin: 0; padding: 8px; background: #fef3c7; border-radius: 4px; font-size: 11px;">
                            <strong>Indicateurs de performance (KPI) :</strong> Ces delais permettent d'identifier les goulots d'etranglement, d'optimiser les processus et de garantir le respect des SLA (Service Level Agreement) entre les equipes METIER et ADC.
                        </p>
                    </div>

                    <p style="margin-top: 15px;"><strong>Equipes impliquees :</strong></p>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li><span style="background: #ef4444; color: white; padding: 1px 6px; border-radius: 3px; font-weight: bold;">METIER_COFAH (GDR)</span> - Demandeur, createur de taches (ouvre et corrige les taches)</li>
                        <li><span style="background: #22c55e; color: white; padding: 1px 6px; border-radius: 3px;">ADC</span> = <span style="background: #f97316; color: white; padding: 1px 6px; border-radius: 3px;">ADC_FINANCE / COMPTA</span> - Traitement des taches (Manager valide, Compta traite)</li>
                    </ul>
                </div>
            </div>

            <!-- Section 2: Workflow Visuel -->
            <div class="modal-section">
                <div class="modal-section-title">2. WORKFLOW DES TACHES - FLUX COMPLET</div>
                <div style="padding: 20px; background: #1e293b; border-radius: 8px; color: white;">
                    <!-- Ligne principale -->
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
                        <div style="text-align: center;">
                            <div style="width: 90px; height: 45px; background: linear-gradient(to bottom, #ef4444, #dc2626); color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 11px;">Ouverture</div>
                            <div style="font-size: 9px; margin-top: 5px; color: #fca5a5;">METIER_COFAH<br/>(GDR)</div>
                        </div>
                        <div style="font-size: 24px; color: #94a3b8;">→</div>
                        <div style="text-align: center;">
                            <div style="width: 90px; height: 45px; background: linear-gradient(to bottom, #f97316, #ea580c); color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 11px;">Creer</div>
                            <div style="font-size: 9px; margin-top: 5px; color: #fca5a5;">METIER_COFAH<br/>(GDR)</div>
                        </div>
                        <div style="font-size: 24px; color: #94a3b8;">→</div>
                        <div style="text-align: center;">
                            <div style="width: 90px; height: 45px; background: linear-gradient(to bottom, #fbbf24, #f59e0b); color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 11px;">A valider</div>
                            <div style="font-size: 9px; margin-top: 5px; color: #86efac;">ADC_FINANCE<br/>(Manager)</div>
                        </div>
                        <div style="font-size: 24px; color: #94a3b8;">→</div>
                        <div style="text-align: center;">
                            <div style="width: 90px; height: 45px; background: linear-gradient(to bottom, #fb923c, #f97316); color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 11px;">A traiter</div>
                            <div style="font-size: 9px; margin-top: 5px; color: #86efac;">COMPTA</div>
                        </div>
                        <div style="font-size: 24px; color: #94a3b8;">→</div>
                        <div style="text-align: center;">
                            <div style="width: 90px; height: 45px; background: linear-gradient(to bottom, #f97316, #ea580c); color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 11px;">Traite</div>
                            <div style="font-size: 9px; margin-top: 5px; color: #86efac;">COMPTA</div>
                        </div>
                        <div style="font-size: 24px; color: #94a3b8;">→</div>
                        <div style="text-align: center;">
                            <div style="width: 90px; height: 45px; background: linear-gradient(to bottom, #22c55e, #16a34a); color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 11px;">Cloture</div>
                            <div style="font-size: 10px; margin-top: 5px; color: #fcd34d;">Auto >90j</div>
                        </div>
                    </div>
                    <!-- Boucle de retour -->
                    <div style="border: 2px dashed #f87171; border-radius: 8px; padding: 15px; margin-top: 10px;">
                        <div style="text-align: center; margin-bottom: 10px;">
                            <span style="background: #dc2626; padding: 4px 12px; border-radius: 4px; font-size: 11px;">BOUCLE DE RETOUR - Traitement non valide</span>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                            <span style="font-size: 11px;">A traiter / Traite</span>
                            <span style="font-size: 20px; color: #f87171;">↺</span>
                            <div style="text-align: center;">
                                <div style="width: 100px; height: 40px; background: linear-gradient(to bottom, #f97316, #ea580c); color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 10px;">Creer<br/>(Apres correction)</div>
                                <div style="font-size: 9px; margin-top: 3px; color: #fca5a5;">METIER_COFAH(GDR)<br/>corrige</div>
                            </div>
                            <span style="font-size: 20px; color: #22c55e;">→</span>
                            <span style="font-size: 11px;">Retour vers A valider</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Transitions detaillees -->
            <div class="modal-section">
                <div class="modal-section-title">3. TRANSITIONS ENTRE ETATS - DETAIL POUR LE DEVELOPPEUR</div>
                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                    <thead>
                        <tr style="background: #1e293b; color: white;">
                            <th style="padding: 10px; border: 1px solid #475569; text-align: left;">Etat Actuel</th>
                            <th style="padding: 10px; border: 1px solid #475569; text-align: left;">Etat Suivant</th>
                            <th style="padding: 10px; border: 1px solid #475569; text-align: left;">Qui ?</th>
                            <th style="padding: 10px; border: 1px solid #475569; text-align: left;">Champs a remplir</th>
                            <th style="padding: 10px; border: 1px solid #475569; text-align: left;">Champs a NE PAS remplir</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #fef2f2;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Ouverture</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 3px;">Creer</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 3px;">METIER_COFAH (GDR)</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #dc2626;"><strong>Valide Manager</strong>, <strong>Statut de tache</strong></td>
                        </tr>
                        <tr style="background: #fff7ed;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Creer</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #fbbf24; color: white; padding: 2px 6px; border-radius: 3px;">A valider</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 3px;">METIER_COFAH (GDR)</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #16a34a;"><strong>Type de tache</strong>, <strong>Service correcteur</strong>, <strong>Valideur</strong>, <strong>Lien Sugar</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #dc2626;"><strong>Valide Manager</strong>, <strong>Statut tache</strong></td>
                        </tr>
                        <tr style="background: #fefce8;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #fbbf24; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">A valider</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #fb923c; color: white; padding: 2px 6px; border-radius: 3px;">A traiter</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 3px;">ADC_FINANCE (Manager)</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #16a34a;"><strong>Manager = Oui</strong> ou <strong>Manager = Non</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                        </tr>
                        <tr style="background: #fff7ed;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #fb923c; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">A traiter</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 3px;">Traite</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 3px;">ADC / Compta</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #16a34a;"><strong>Statut tache = Traite</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                        </tr>
                        <tr style="background: #fef2f2;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #fb923c; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">A traiter</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 3px;">Creer (Apres correction)</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 3px;">ADC / Compta</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #dc2626;"><strong>Statut tache = Traitement non valide</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                        </tr>
                        <tr style="background: #fff7ed;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Traite</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 3px;">Cloture</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 3px;">ADC / Compta</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #16a34a;"><strong>Statut tache = Cloture</strong><br/><em style="font-size: 10px; color: #666;">+ Cloture auto si >90 jours</em></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                        </tr>
                        <tr style="background: #fef2f2;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Traite</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 3px;">Creer (Apres correction)</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 3px;">ADC / Compta</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #dc2626;"><strong>Statut tache = Traitement non valide</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                        </tr>
                        <tr style="background: #f0fdf4;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Creer (Apres correction)</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #fbbf24; color: white; padding: 2px 6px; border-radius: 3px;">A valider</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 3px;">METIER_COFAH (GDR)</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #16a34a;"><strong>Statut tache = Transmis</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #dc2626;"><strong>Valide Manager</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Section 4: Roles et Permissions -->
            <div class="modal-section">
                <div class="modal-section-title">4. ROLES ET PERMISSIONS</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- METIER_COFAH (GDR) -->
                    <div style="background: #fef2f2; border: 2px solid #ef4444; border-radius: 8px; padding: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #dc2626;"><span style="background: #ef4444; color: white; padding: 3px 10px; border-radius: 4px;">METIER_COFAH (GDR)</span></h4>
                        <p style="font-size: 11px; margin-bottom: 10px;"><strong>Role :</strong> Demandeur / Createur de taches</p>
                        <p style="font-size: 11px; margin-bottom: 5px;"><strong>Actions autorisees :</strong></p>
                        <ul style="font-size: 11px; margin-left: 15px;">
                            <li>Creer une tache (Ouverture → Creer)</li>
                            <li>Remplir les champs obligatoires</li>
                            <li>Corriger une tache rejetee (Creer Apres correction)</li>
                            <li>Transmettre la tache corrigee (Statut = Transmis)</li>
                        </ul>
                        <p style="font-size: 11px; margin-top: 10px; color: #dc2626;"><strong>Interdit :</strong> Remplir "Valide Manager", "Statut tache"</p>
                    </div>
                    <!-- ADC = ADC_FINANCE / COMPTA -->
                    <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px; padding: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #16a34a;"><span style="background: #22c55e; color: white; padding: 3px 10px; border-radius: 4px;">ADC</span> = <span style="background: #f97316; color: white; padding: 3px 10px; border-radius: 4px;">ADC_FINANCE / COMPTA</span></h4>
                        <p style="font-size: 11px; margin-bottom: 10px;"><strong>Sous-roles :</strong></p>
                        <div style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                            <strong style="color: #16a34a;">ADC Manager</strong>
                            <ul style="font-size: 10px; margin: 5px 0 0 15px;">
                                <li>Valider les taches (A valider → A traiter)</li>
                                <li>Remplir "Manager = Oui" ou "Manager = Non"</li>
                            </ul>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 4px;">
                            <strong style="color: #16a34a;">ADC Compta</strong>
                            <ul style="font-size: 10px; margin: 5px 0 0 15px;">
                                <li>Traiter les taches (A traiter → Traite)</li>
                                <li>Cloturer (Traite → Cloture)</li>
                                <li>Rejeter vers METIER_COFAH (Statut = Traitement non valide)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 5: Champs par Etat -->
            <div class="modal-section">
                <div class="modal-section-title">5. CHAMPS A REMPLIR PAR ETAT</div>
                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                    <thead>
                        <tr style="background: #e8e4d9;">
                            <th style="padding: 8px; border: 1px solid #ccc;">Champ</th>
                            <th style="padding: 8px; border: 1px solid #ccc;">Ouverture</th>
                            <th style="padding: 8px; border: 1px solid #ccc;">Creer</th>
                            <th style="padding: 8px; border: 1px solid #ccc;">A valider</th>
                            <th style="padding: 8px; border: 1px solid #ccc;">A traiter</th>
                            <th style="padding: 8px; border: 1px solid #ccc;">Traite</th>
                            <th style="padding: 8px; border: 1px solid #ccc;">Cloture</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td style="padding: 6px; border: 1px solid #ddd; font-weight: bold;">Type de tache</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center; background: #dcfce7;">OUI</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td></tr>
                        <tr style="background: #fafafa;"><td style="padding: 6px; border: 1px solid #ddd; font-weight: bold;">Service correcteur</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center; background: #dcfce7;">OUI</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td></tr>
                        <tr><td style="padding: 6px; border: 1px solid #ddd; font-weight: bold;">Valideur</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center; background: #dcfce7;">OUI</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td></tr>
                        <tr style="background: #fafafa;"><td style="padding: 6px; border: 1px solid #ddd; font-weight: bold;">Lien Sugar</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center; background: #dcfce7;">OUI</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td></tr>
                        <tr><td style="padding: 6px; border: 1px solid #ddd; font-weight: bold;">Valide Manager</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center; background: #fee2e2;">NON</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center; background: #fee2e2;">NON</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center; background: #dcfce7;">OUI/NON</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td></tr>
                        <tr style="background: #fafafa;"><td style="padding: 6px; border: 1px solid #ddd; font-weight: bold;">Statut tache</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center; background: #fee2e2;">NON</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center; background: #fee2e2;">NON</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center; background: #dcfce7;">Traite</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center; background: #dcfce7;">Cloture</td><td style="padding: 6px; border: 1px solid #ddd; text-align: center;">-</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Section 6: Regles de gestion -->
            <div class="modal-section">
                <div class="modal-section-title">6. REGLES DE GESTION METIER</div>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 4px;">
                    <p style="margin-bottom: 10px;"><strong>RG01 - Creation :</strong> Seul un utilisateur <span style="background: #ef4444; color: white; padding: 1px 6px; border-radius: 3px;">METIER_COFAH (GDR)</span> peut creer une tache en statut "Ouverture".</p>
                    <p style="margin-bottom: 10px;"><strong>RG02 - Validation Manager :</strong> Seul un utilisateur <span style="background: #22c55e; color: white; padding: 1px 6px; border-radius: 3px;">ADC_FINANCE</span> avec le role <strong>Manager</strong> peut valider une tache (A valider → A traiter).</p>
                    <p style="margin-bottom: 10px;"><strong>RG03 - Traitement :</strong> Seul un utilisateur <span style="background: #22c55e; color: white; padding: 1px 6px; border-radius: 3px;">COMPTA</span> peut traiter une tache.</p>
                    <p style="margin-bottom: 10px;"><strong>RG04 - Rejet :</strong> Si COMPTA rejette une tache (Traitement non valide), elle retourne vers <span style="background: #ef4444; color: white; padding: 1px 6px; border-radius: 3px;">METIER_COFAH</span> en statut "Creer (Apres correction)".</p>
                    <p style="margin-bottom: 10px;"><strong>RG05 - Correction :</strong> <span style="background: #ef4444; color: white; padding: 1px 6px; border-radius: 3px;">METIER_COFAH</span> doit corriger la tache et la transmettre avec "Statut tache = Transmis".</p>
                    <p style="margin-bottom: 10px;"><strong>RG06 - Cloture auto :</strong> Une tache en statut "Traite" depuis plus de <strong>90 jours</strong> est automatiquement cloturee par le systeme.</p>
                    <p style="margin-bottom: 0;"><strong>RG07 - Champs proteges :</strong> <span style="background: #ef4444; color: white; padding: 1px 6px; border-radius: 3px;">METIER_COFAH</span> ne peut jamais modifier "Valide Manager" et "Statut tache" lors de la creation initiale.</p>
                </div>
            </div>

            <!-- Section 7: Diagramme technique -->
            <div class="modal-section">
                <div class="modal-section-title">7. IMPLEMENTATION TECHNIQUE - PSEUDO-CODE</div>
                <div style="background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 11px; overflow-x: auto;">
<pre style="margin: 0; white-space: pre-wrap;">
// TRANSITION : Creer → A valider (METIER_COFAH)
function transitionToAValider(tache, user) {
    if (user.groupe !== 'METIER_COFAH') throw Error('Acces refuse');
    if (!tache.typeTache || !tache.serviceCorrecteur || !tache.valideur || !tache.lienSugar) {
        throw Error('Champs obligatoires manquants');
    }
    // METIER_COFAH ne peut pas remplir ces champs
    tache.valideManager = null;  // PROTECTED
    tache.statutTache = null;    // PROTECTED
    tache.statut = 'A_VALIDER';
    return save(tache);
}

// TRANSITION : A valider → A traiter (ADC Manager)
function transitionToATraiter(tache, user) {
    if (user.groupe !== 'ADC' || user.role !== 'MANAGER') throw Error('Acces refuse');
    tache.valideManager = user.decision; // 'Oui' ou 'Non'
    tache.statut = 'A_TRAITER';
    return save(tache);
}

// TRANSITION : A traiter → Traite OU Creer(correction) (ADC Compta)
function transitionFromATraiter(tache, user, action) {
    if (user.groupe !== 'ADC') throw Error('Acces refuse');
    if (action === 'TRAITER') {
        tache.statutTache = 'Traite';
        tache.statut = 'TRAITE';
    } else if (action === 'REJETER') {
        tache.statutTache = 'Traitement non valide';
        tache.statut = 'CREER_CORRECTION';  // Retour vers METIER_COFAH
    }
    return save(tache);
}

// CLOTURE AUTOMATIQUE (Batch job)
function autoClotureJob() {
    const taches = findByStatut('TRAITE').filter(t => daysSince(t.dateTraite) > 90);
    taches.forEach(t => { t.statut = 'CLOTURE'; save(t); });
}
</pre>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal WORKFLOW ADC - Specification Fonctionnelle Detaillee -->
<div id="adc-workflow-modal" class="modal-overlay" onclick="closeADCWorkflowModalOnOverlay(event)">
    <div class="modal" style="max-width: 1200px;">
        <div class="modal-header" style="background: linear-gradient(to bottom, #22c55e, #16a34a);">
            <h3>WORKFLOW ADC - Taches traitees par ADC uniquement</h3>
            <button class="modal-close" onclick="closeADCWorkflowModal()">&times;</button>
        </div>
        <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">

            <!-- Section 1: Contexte -->
            <div class="modal-section">
                <div class="modal-section-title">1. CONTEXTE ET OBJECTIF</div>
                <div style="padding: 15px; background: #f0fdf4; border-radius: 4px; border-left: 4px solid #22c55e;">
                    <p><strong>Application :</strong> ACCURATE</p>
                    <p><strong>Module :</strong> Workflow ADC - Gestion des taches internes ADC</p>
                    <p><strong>Objectif fonctionnel :</strong> Permettre a l'equipe <span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 3px; font-weight: bold;">ADC</span> de creer ET traiter les taches en interne, sans intervention du METIER.</p>

                    <!-- Objectif principal : Delais de traitement -->
                    <div style="margin-top: 15px; padding: 15px; background: #dcfce7; border-radius: 6px; border-left: 4px solid #16a34a;">
                        <p style="margin: 0 0 10px 0; font-weight: bold; color: #166534; font-size: 13px;">OBJECTIF PRINCIPAL : Mesurer les delais de traitement internes ADC</p>
                        <p style="margin: 0 0 10px 0;">Ce workflow permet de <strong>suivre et analyser les delais de traitement des taches</strong> au sein de l'equipe ADC :</p>
                        <ul style="margin: 0 0 10px 20px;">
                            <li><strong>Delai de validation Manager :</strong> Temps entre la creation et la validation par le Manager ADC</li>
                            <li><strong>Delai de traitement Compta :</strong> Temps entre l'assignation (A traiter) et le traitement effectif (Traite)</li>
                            <li><strong>Delai de correction :</strong> Temps de retour apres un rejet interne (boucle Traitement non valide)</li>
                            <li><strong>Delai total :</strong> Temps entre l'ouverture et la cloture de la tache</li>
                        </ul>
                        <p style="margin: 0; padding: 8px; background: #fef3c7; border-radius: 4px; font-size: 11px;">
                            <strong>Indicateurs de performance (KPI) :</strong> Ces delais permettent de mesurer l'efficacite interne de l'equipe ADC, sans dependance externe au METIER.
                        </p>
                    </div>

                    <p style="margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 4px; border-left: 4px solid #f59e0b;">
                        <strong>DIFFERENCE avec Workflow Metier :</strong><br/>
                        Dans le <strong>Workflow ADC</strong>, la tache est creee par ADC et traitee par ADC (circuit interne).<br/>
                        Dans le <strong>Workflow Metier</strong>, la tache est creee par METIER_COFAH et traitee par ADC (circuit inter-equipes).
                    </p>
                </div>
            </div>

            <!-- Section 2: Workflow Visuel -->
            <div class="modal-section">
                <div class="modal-section-title">2. WORKFLOW ADC - FLUX COMPLET</div>
                <div style="padding: 20px; background: #1e293b; border-radius: 8px; color: white;">
                    <!-- Ligne principale -->
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
                        <div style="text-align: center;">
                            <div style="width: 90px; height: 45px; background: linear-gradient(to bottom, #ef4444, #dc2626); color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 11px;">Ouverture</div>
                            <div style="font-size: 9px; margin-top: 5px; color: #86efac;">ADC</div>
                        </div>
                        <div style="font-size: 24px; color: #94a3b8;">→</div>
                        <div style="text-align: center;">
                            <div style="width: 90px; height: 45px; background: linear-gradient(to bottom, #f97316, #ea580c); color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 11px;">Creer</div>
                            <div style="font-size: 9px; margin-top: 5px; color: #86efac;">ADC</div>
                        </div>
                        <div style="font-size: 24px; color: #94a3b8;">→</div>
                        <div style="text-align: center;">
                            <div style="width: 90px; height: 45px; background: linear-gradient(to bottom, #fbbf24, #f59e0b); color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 11px;">A valider</div>
                            <div style="font-size: 9px; margin-top: 5px; color: #86efac;">ADC (Manager)</div>
                        </div>
                        <div style="font-size: 24px; color: #94a3b8;">→</div>
                        <div style="text-align: center;">
                            <div style="width: 90px; height: 45px; background: linear-gradient(to bottom, #fb923c, #f97316); color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 11px;">A traiter</div>
                            <div style="font-size: 9px; margin-top: 5px; color: #86efac;">Compta</div>
                        </div>
                        <div style="font-size: 24px; color: #94a3b8;">→</div>
                        <div style="text-align: center;">
                            <div style="width: 90px; height: 45px; background: linear-gradient(to bottom, #f97316, #ea580c); color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 11px;">Traite</div>
                            <div style="font-size: 9px; margin-top: 5px; color: #86efac;">ADC</div>
                        </div>
                        <div style="font-size: 24px; color: #94a3b8;">→</div>
                        <div style="text-align: center;">
                            <div style="width: 90px; height: 45px; background: linear-gradient(to bottom, #22c55e, #16a34a); color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 11px;">Cloture</div>
                            <div style="font-size: 9px; margin-top: 5px; color: #fcd34d;">Auto >90j</div>
                        </div>
                    </div>
                    <!-- Boucle de retour -->
                    <div style="border: 2px dashed #f87171; border-radius: 8px; padding: 15px; margin-top: 10px;">
                        <div style="text-align: center; margin-bottom: 10px;">
                            <span style="background: #dc2626; padding: 4px 12px; border-radius: 4px; font-size: 11px;">BOUCLE DE RETOUR - Traitement non valide</span>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                            <span style="font-size: 11px;">A traiter / Traite</span>
                            <span style="font-size: 20px; color: #f87171;">↺</span>
                            <div style="text-align: center;">
                                <div style="width: 100px; height: 40px; background: linear-gradient(to bottom, #f97316, #ea580c); color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 10px;">Creer<br/>(Apres correction)</div>
                                <div style="font-size: 9px; margin-top: 3px; color: #86efac;">ADC corrige</div>
                            </div>
                            <span style="font-size: 20px; color: #22c55e;">→</span>
                            <span style="font-size: 11px;">Retour vers A valider</span>
                        </div>
                    </div>
                    <!-- Note importante -->
                    <div style="margin-top: 15px; padding: 10px; background: rgba(34, 197, 94, 0.2); border-radius: 4px; text-align: center;">
                        <span style="color: #86efac; font-weight: bold;">TOUT LE WORKFLOW EST GERE PAR L'EQUIPE ADC</span>
                    </div>
                </div>
            </div>

            <!-- Section 3: Transitions detaillees -->
            <div class="modal-section">
                <div class="modal-section-title">3. TRANSITIONS ENTRE ETATS - DETAIL POUR LE DEVELOPPEUR</div>
                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                    <thead>
                        <tr style="background: #166534; color: white;">
                            <th style="padding: 10px; border: 1px solid #15803d; text-align: left;">Etat Actuel</th>
                            <th style="padding: 10px; border: 1px solid #15803d; text-align: left;">Etat Suivant</th>
                            <th style="padding: 10px; border: 1px solid #15803d; text-align: left;">Qui ?</th>
                            <th style="padding: 10px; border: 1px solid #15803d; text-align: left;">Champs a remplir</th>
                            <th style="padding: 10px; border: 1px solid #15803d; text-align: left;">Champs a NE PAS remplir</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #f0fdf4;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Ouverture</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 3px;">Creer</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 3px;">ADC</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #dc2626;"><strong>Valide Manager</strong>, <strong>Statut de tache</strong></td>
                        </tr>
                        <tr style="background: #dcfce7;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Creer</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #fbbf24; color: white; padding: 2px 6px; border-radius: 3px;">A valider</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 3px;">ADC</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #16a34a;"><strong>Type de tache</strong>, <strong>Service correcteur</strong>, <strong>Valideur</strong>, <strong>Lien Sugar</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #dc2626;"><strong>Valide Manager</strong>, <strong>Statut tache</strong></td>
                        </tr>
                        <tr style="background: #f0fdf4;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #fbbf24; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">A valider</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #fb923c; color: white; padding: 2px 6px; border-radius: 3px;">A traiter</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 3px;">ADC (Manager)</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #16a34a;"><strong>Manager = Oui</strong> ou <strong>Manager = Non</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                        </tr>
                        <tr style="background: #dcfce7;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #fb923c; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">A traiter</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 3px;">Traite</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 3px;">Compta</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #16a34a;"><strong>Statut tache = Traite</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                        </tr>
                        <tr style="background: #fef2f2;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #fb923c; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">A traiter</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 3px;">Creer (Apres correction)</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 3px;">Compta</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #dc2626;"><strong>Statut tache = Traitement non valide</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                        </tr>
                        <tr style="background: #dcfce7;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Traite</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 3px;">Cloture</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 3px;">ADC</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #16a34a;"><strong>Statut tache = Cloture</strong><br/><em style="font-size: 10px; color: #666;">+ Cloture auto si >90 jours</em></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                        </tr>
                        <tr style="background: #fef2f2;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Traite</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 3px;">Creer (Apres correction)</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 3px;">ADC</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #dc2626;"><strong>Statut tache = Traitement non valide</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                        </tr>
                        <tr style="background: #dcfce7;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Creer (Apres correction)</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #fbbf24; color: white; padding: 2px 6px; border-radius: 3px;">A valider</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd;"><span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 3px;">ADC</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #16a34a;"><strong>Statut tache = Transmis</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #dc2626;"><strong>Valide Manager</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Section 4: Comparaison Workflow Metier vs ADC -->
            <div class="modal-section">
                <div class="modal-section-title">4. COMPARAISON : WORKFLOW METIER vs WORKFLOW ADC</div>
                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                    <thead>
                        <tr style="background: #1e293b; color: white;">
                            <th style="padding: 10px; border: 1px solid #475569; text-align: left;">Critere</th>
                            <th style="padding: 10px; border: 1px solid #475569; text-align: center; background: #ef4444;">Workflow METIER</th>
                            <th style="padding: 10px; border: 1px solid #475569; text-align: center; background: #22c55e;">Workflow ADC</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Qui cree la tache ?</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #fef2f2;"><span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 3px;">METIER_COFAH (GDR)</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #f0fdf4;"><span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 3px;">ADC</span></td>
                        </tr>
                        <tr style="background: #fafafa;">
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Qui valide (Manager) ?</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 3px;">ADC_FINANCE (Manager)</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 3px;">ADC (Manager)</span></td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Qui traite ?</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 3px;">COMPTA</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 3px;">Compta</span></td>
                        </tr>
                        <tr style="background: #fafafa;">
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Qui corrige apres rejet ?</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #fef2f2;"><span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 3px;">METIER_COFAH (GDR)</span></td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #f0fdf4;"><span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 3px;">ADC</span></td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Cloture automatique</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">>90 jours</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">>90 jours</td>
                        </tr>
                        <tr style="background: #fafafa;">
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Interactions inter-equipes</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #fef2f2;"><strong style="color: #dc2626;">OUI</strong> (METIER ↔ ADC)</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #f0fdf4;"><strong style="color: #22c55e;">NON</strong> (ADC uniquement)</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Section 5: Regles de gestion -->
            <div class="modal-section">
                <div class="modal-section-title">5. REGLES DE GESTION - WORKFLOW ADC</div>
                <div style="padding: 15px; background: #f0fdf4; border-radius: 4px; border-left: 4px solid #22c55e;">
                    <p style="margin-bottom: 10px;"><strong>RG01 - Creation :</strong> Seul un utilisateur <span style="background: #22c55e; color: white; padding: 1px 6px; border-radius: 3px;">ADC</span> peut creer une tache en statut "Ouverture".</p>
                    <p style="margin-bottom: 10px;"><strong>RG02 - Validation Manager :</strong> Seul un utilisateur <span style="background: #22c55e; color: white; padding: 1px 6px; border-radius: 3px;">ADC</span> avec le role <strong>Manager</strong> peut valider une tache (A valider → A traiter).</p>
                    <p style="margin-bottom: 10px;"><strong>RG03 - Traitement :</strong> Seul un utilisateur <span style="background: #22c55e; color: white; padding: 1px 6px; border-radius: 3px;">Compta</span> peut traiter une tache.</p>
                    <p style="margin-bottom: 10px;"><strong>RG04 - Rejet :</strong> Si Compta ou ADC rejette une tache (Traitement non valide), elle retourne vers <span style="background: #22c55e; color: white; padding: 1px 6px; border-radius: 3px;">ADC</span> en statut "Creer (Apres correction)".</p>
                    <p style="margin-bottom: 10px;"><strong>RG05 - Correction :</strong> <span style="background: #22c55e; color: white; padding: 1px 6px; border-radius: 3px;">ADC</span> corrige la tache et la transmet avec "Statut tache = Transmis".</p>
                    <p style="margin-bottom: 10px;"><strong>RG06 - Cloture auto :</strong> Une tache en statut "Traite" depuis plus de <strong>90 jours</strong> est automatiquement cloturee par le systeme.</p>
                    <p style="margin-bottom: 0;"><strong>RG07 - Circuit interne :</strong> <span style="background: #22c55e; color: white; padding: 1px 6px; border-radius: 3px;">TOUTES LES ETAPES</span> sont gerees par l'equipe ADC (pas d'intervention METIER).</p>
                </div>
            </div>

            <!-- Section 6: Implementation technique -->
            <div class="modal-section">
                <div class="modal-section-title">6. IMPLEMENTATION TECHNIQUE - PSEUDO-CODE</div>
                <div style="background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 11px; overflow-x: auto;">
<pre style="margin: 0; white-space: pre-wrap;">
// WORKFLOW ADC : Toutes les etapes sont gerees par ADC

// TRANSITION : Creer → A valider (ADC)
function transitionToAValider_ADC(tache, user) {
    if (user.groupe !== 'ADC') throw Error('Acces refuse - ADC uniquement');
    if (!tache.typeTache || !tache.serviceCorrecteur || !tache.valideur || !tache.lienSugar) {
        throw Error('Champs obligatoires manquants');
    }
    tache.valideManager = null;  // PROTECTED
    tache.statutTache = null;    // PROTECTED
    tache.statut = 'A_VALIDER';
    tache.workflow = 'ADC';      // Marqueur workflow ADC
    return save(tache);
}

// TRANSITION : A valider → A traiter (ADC Manager)
function transitionToATraiter_ADC(tache, user) {
    if (user.groupe !== 'ADC' || user.role !== 'MANAGER') throw Error('Acces refuse');
    tache.valideManager = user.decision; // 'Oui' ou 'Non'
    tache.statut = 'A_TRAITER';
    return save(tache);
}

// TRANSITION : A traiter → Traite OU Creer(correction) (Compta)
function transitionFromATraiter_ADC(tache, user, action) {
    if (user.groupe !== 'ADC' && user.role !== 'COMPTA') throw Error('Acces refuse');
    if (action === 'TRAITER') {
        tache.statutTache = 'Traite';
        tache.statut = 'TRAITE';
    } else if (action === 'REJETER') {
        tache.statutTache = 'Traitement non valide';
        tache.statut = 'CREER_CORRECTION';  // Retour vers ADC (pas METIER)
    }
    return save(tache);
}

// DISTINCTION WORKFLOW : Verification du type
function getWorkflowType(tache) {
    return tache.creePar.groupe === 'ADC' ? 'WORKFLOW_ADC' : 'WORKFLOW_METIER';
}
</pre>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
// ============================================================================
// SFD MODAL FUNCTIONS (Workflow Metier)
// ============================================================================
function openSFDModal() {
    document.getElementById('sfd-modal').classList.add('visible');
}

function closeSFDModal() {
    document.getElementById('sfd-modal').classList.remove('visible');
}

function closeSFDModalOnOverlay(event) {
    if (event.target === document.getElementById('sfd-modal')) {
        closeSFDModal();
    }
}

// ============================================================================
// ADC WORKFLOW MODAL FUNCTIONS
// ============================================================================
function openADCWorkflowModal() {
    document.getElementById('adc-workflow-modal').classList.add('visible');
}

function closeADCWorkflowModal() {
    document.getElementById('adc-workflow-modal').classList.remove('visible');
}

function closeADCWorkflowModalOnOverlay(event) {
    if (event.target === document.getElementById('adc-workflow-modal')) {
        closeADCWorkflowModal();
    }
}

// ============================================================================
// SIDEBAR TOGGLE FUNCTION
// ============================================================================
function toggleSidebarMenu(menuId, parentElement) {
    const submenu = document.getElementById(menuId);
    const expandIcon = parentElement.querySelector('.expand');

    if (submenu.style.display === 'none' || submenu.style.display === '') {
        submenu.style.display = 'block';
        expandIcon.textContent = 'v';
    } else {
        submenu.style.display = 'none';
        expandIcon.textContent = '>';
    }
}

// ============================================================================
// DONNEES DU GRAPHIQUE PAR ANNEE/MOIS (delai moyen)
// ============================================================================
const chartData = {
    '2024': {
        '01': { delai: 5.2, label: 'janv. 2024' },
        '02': { delai: 4.8, label: 'fevr. 2024' },
        '03': { delai: 6.1, label: 'mars 2024' },
        '04': { delai: 5.5, label: 'avr. 2024' },
        '05': { delai: 4.2, label: 'mai 2024' },
        '06': { delai: 5.9, label: 'juin 2024' },
        '07': { delai: 6.8, label: 'juil. 2024' },
        '08': { delai: 3.1, label: 'aout 2024' },
        '09': { delai: 4.5, label: 'sept. 2024' },
        '10': { delai: 5.3, label: 'oct. 2024' },
        '11': { delai: 4.9, label: 'nov. 2024' },
        '12': { delai: 6.2, label: 'dec. 2024' }
    },
    '2025': {
        '01': { delai: 3.45, label: 'janv. 2025' },
        '02': { delai: 4.73, label: 'fevr. 2025' },
        '03': { delai: 4.14, label: 'mars 2025' },
        '04': { delai: 3.36, label: 'avr. 2025' },
        '05': { delai: 4.89, label: 'mai 2025' },
        '06': { delai: 7.01, label: 'juin 2025' },
        '07': { delai: 3.61, label: 'juil. 2025' },
        '08': { delai: 1.28, label: 'aout 2025' },
        '09': { delai: 2.95, label: 'sept. 2025' },
        '10': { delai: 3.82, label: 'oct. 2025' },
        '11': { delai: 4.15, label: 'nov. 2025' },
        '12': { delai: 3.67, label: 'dec. 2025' }
    },
    '2026': {
        '01': { delai: 2.8, label: 'janv. 2026' },
        '02': { delai: 3.2, label: 'fevr. 2026' }
    }
};

// Noms des mois pour affichage
const moisNoms = {
    '01': 'Janvier', '02': 'Fevrier', '03': 'Mars', '04': 'Avril',
    '05': 'Mai', '06': 'Juin', '07': 'Juillet', '08': 'Aout',
    '09': 'Septembre', '10': 'Octobre', '11': 'Novembre', '12': 'Decembre'
};

// ============================================================================
// FONCTION DE MISE A JOUR DU GRAPHIQUE
// ============================================================================
function updateChart() {
    const annee = document.getElementById('filter-annee').value;
    const mois = document.getElementById('filter-mois').value;
    const container = document.getElementById('bar-chart-container');

    // Garder l'axe Y
    let html = `<div class="y-axis">
        <span>8.00</span>
        <span>6.00</span>
        <span>4.00</span>
        <span>2.00</span>
        <span>0.00</span>
    </div>`;

    const yearData = chartData[annee] || {};

    if (mois === 'tous') {
        // Afficher tous les mois de l'annee
        for (const m in yearData) {
            const data = yearData[m];
            const height = Math.min(data.delai * 35, 280); // 35px par jour, max 280px
            const moisKey = moisNoms[m] + ' ' + annee;
            html += `
                <div class="bar-item">
                    <div class="bar" style="height: ${height}px;" onclick="showDetail('${moisKey}')">
                        <span class="bar-value">${data.delai.toFixed(2)}</span>
                    </div>
                    <span class="bar-label">${data.label}</span>
                </div>`;
        }
    } else {
        // Afficher un seul mois
        const data = yearData[mois];
        if (data) {
            const height = Math.min(data.delai * 35, 280);
            const moisKey = moisNoms[mois] + ' ' + annee;
            html += `
                <div class="bar-item" style="flex: 0 0 150px;">
                    <div class="bar" style="height: ${height}px; width: 80px;" onclick="showDetail('${moisKey}')">
                        <span class="bar-value">${data.delai.toFixed(2)}</span>
                    </div>
                    <span class="bar-label">${data.label}</span>
                </div>`;
        } else {
            html += `<div style="padding: 50px; color: #666; text-align: center; width: 100%;">Aucune donnee pour ${moisNoms[mois]} ${annee}</div>`;
        }
    }

    container.innerHTML = html;

    // Masquer le detail si affiche
    hideDetail();
}

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', function() {
    updateChart();
});

// ============================================================================
// Donnees de test par mois (avec toutes les colonnes)
const testData = {
    'Janvier 2025': [
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:9', dateCreation: '02/01/2025', dateTraitement: '05/01/2025', delai: 3, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '09:15:32', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '8 250.00 EUR', libelle: 'Encaissement cheque client REF-2025-0109', interlocuteur: 'Pierre DURAND - Comptabilite' },
        { uid: 'j08234', nom: 'MARTIN Jean', reference: '13:11', dateCreation: '10/01/2025', dateTraitement: '14/01/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '11:22:18', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'GROUPE ALPHA', isin: 'FR0000131104', compteBancaire: 'FR76 3000 4025 6700 0200 0456 789', montant: '15 780.50 EUR', libelle: 'Reglement facture F-2025-0234', interlocuteur: 'Marie LEFEBVRE - Tresorerie' },
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:13', dateCreation: '15/01/2025', dateTraitement: '18/01/2025', delai: 3, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '14:45:07', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '3 420.00 EUR', libelle: 'Acompte commande CMD-2025-0089', interlocuteur: 'Luc MOREAU - Direction Financiere' },
        { uid: 'j09412', nom: 'BERNARD Sophie', reference: '13:15', dateCreation: '20/01/2025', dateTraitement: '24/01/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '16:30:55', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'FINEXIA', isin: 'FR0000127771', compteBancaire: 'FR76 3000 4025 6700 0300 0789 012', montant: '22 100.00 EUR', libelle: 'Solde compte client C-4521', interlocuteur: 'Anne ROBERT - Comptabilite Clients' },
    ],
    'Fevrier 2025': [
        { uid: 'j08234', nom: 'MARTIN Jean', reference: '13:17', dateCreation: '01/02/2025', dateTraitement: '06/02/2025', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '08:55:12', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'GROUPE ALPHA', isin: 'FR0000131104', compteBancaire: 'FR76 3000 4025 6700 0200 0456 789', montant: '45 670.00 EUR', libelle: 'Reglement trimestre Q4-2024', interlocuteur: 'Sophie BERNARD - Tresorerie' },
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:19', dateCreation: '05/02/2025', dateTraitement: '09/02/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '10:20:33', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '7 890.25 EUR', libelle: 'Facture F-2025-0412', interlocuteur: 'Jean PETIT - Comptabilite' },
        { uid: 'j05678', nom: 'PETIT Nicolas', reference: '13:20', dateCreation: '12/02/2025', dateTraitement: '17/02/2025', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '13:48:29', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'BETA INDUSTRIE', isin: 'FR0000125007', compteBancaire: 'FR76 3000 4025 6700 0400 0345 678', montant: '18 340.00 EUR', libelle: 'Commande express EXP-2025-0078', interlocuteur: 'Paul GARCIA - Achats' },
    ],
    'Mars 2025': [
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:21', dateCreation: '01/03/2025', dateTraitement: '05/03/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '09:10:45', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '5 600.00 EUR', libelle: 'Avoir client AV-2025-0023', interlocuteur: 'Claire SIMON - Comptabilite' },
        { uid: 'j09412', nom: 'BERNARD Sophie', reference: '13:23', dateCreation: '10/03/2025', dateTraitement: '14/03/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '11:35:18', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'FINEXIA', isin: 'FR0000127771', compteBancaire: 'FR76 3000 4025 6700 0300 0789 012', montant: '31 250.75 EUR', libelle: 'Facture annuelle FA-2025', interlocuteur: 'Marc DUVAL - Direction' },
        { uid: 'j08234', nom: 'MARTIN Jean', reference: '13:24', dateCreation: '15/03/2025', dateTraitement: '20/03/2025', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '15:22:40', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'GROUPE ALPHA', isin: 'FR0000131104', compteBancaire: 'FR76 3000 4025 6700 0200 0456 789', montant: '12 890.00 EUR', libelle: 'Reglement partiel RP-2025-0156', interlocuteur: 'Julie MARTIN - Tresorerie' },
    ],
    'Avril 2025': [
        { uid: 'j05678', nom: 'PETIT Nicolas', reference: '13:25', dateCreation: '02/04/2025', dateTraitement: '05/04/2025', delai: 3, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '08:30:12', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'BETA INDUSTRIE', isin: 'FR0000125007', compteBancaire: 'FR76 3000 4025 6700 0400 0345 678', montant: '9 450.00 EUR', libelle: 'Commande standard CMD-2025-0234', interlocuteur: 'Thomas LEROY - Achats' },
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:27', dateCreation: '08/04/2025', dateTraitement: '12/04/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '14:15:55', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '27 800.50 EUR', libelle: 'Solde exercice SE-2025', interlocuteur: 'Emma BLANC - Direction Financiere' },
    ],
    'Mai 2025': [
        { uid: 'j08234', nom: 'MARTIN Jean', reference: '13:28', dateCreation: '01/05/2025', dateTraitement: '06/05/2025', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '09:45:30', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'GROUPE ALPHA', isin: 'FR0000131104', compteBancaire: 'FR76 3000 4025 6700 0200 0456 789', montant: '16 720.00 EUR', libelle: 'Facture mensuelle FM-2025-05', interlocuteur: 'Nicolas ROUX - Comptabilite' },
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:29', dateCreation: '05/05/2025', dateTraitement: '10/05/2025', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '11:20:18', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '4 560.00 EUR', libelle: 'Acompte projet PRJ-2025-0089', interlocuteur: 'Lucas MOREL - Projets' },
        { uid: 'j09412', nom: 'BERNARD Sophie', reference: '13:30', dateCreation: '12/05/2025', dateTraitement: '17/05/2025', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '14:55:42', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'FINEXIA', isin: 'FR0000127771', compteBancaire: 'FR76 3000 4025 6700 0300 0789 012', montant: '38 900.00 EUR', libelle: 'Contrat annuel CA-2025', interlocuteur: 'Sarah DUPUIS - Commercial' },
        { uid: 'j05678', nom: 'PETIT Nicolas', reference: '13:31', dateCreation: '20/05/2025', dateTraitement: '25/05/2025', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '16:10:05', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'BETA INDUSTRIE', isin: 'FR0000125007', compteBancaire: 'FR76 3000 4025 6700 0400 0345 678', montant: '11 230.75 EUR', libelle: 'Livraison urgente LIV-2025-0412', interlocuteur: 'Antoine GIRARD - Logistique' },
    ],
    'Juin 2025': [
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:32', dateCreation: '01/06/2025', dateTraitement: '10/06/2025', delai: 9, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '14:32:45', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '12 450.00 EUR', libelle: 'Encaissement cheque client REF-2025-0632', interlocuteur: 'Jean-Pierre MARTIN - Direction Financiere' },
        { uid: 'j08234', nom: 'MARTIN Jean', reference: '13:33', dateCreation: '05/06/2025', dateTraitement: '12/06/2025', delai: 7, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '10:18:22', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'GROUPE ALPHA', isin: 'FR0000131104', compteBancaire: 'FR76 3000 4025 6700 0200 0456 789', montant: '23 670.00 EUR', libelle: 'Reglement exceptionnel RX-2025-06', interlocuteur: 'Catherine FAURE - Tresorerie' },
        { uid: 'j09412', nom: 'BERNARD Sophie', reference: '13:34', dateCreation: '10/06/2025', dateTraitement: '18/06/2025', delai: 8, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '09:05:33', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'FINEXIA', isin: 'FR0000127771', compteBancaire: 'FR76 3000 4025 6700 0300 0789 012', montant: '56 780.50 EUR', libelle: 'Investissement projet INV-2025', interlocuteur: 'Philippe LAMBERT - Investissements' },
        { uid: 'j05678', nom: 'PETIT Nicolas', reference: '13:35', dateCreation: '15/06/2025', dateTraitement: '20/06/2025', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '13:42:10', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'BETA INDUSTRIE', isin: 'FR0000125007', compteBancaire: 'FR76 3000 4025 6700 0400 0345 678', montant: '8 920.00 EUR', libelle: 'Facture standard FS-2025-0678', interlocuteur: 'Isabelle MERCIER - Comptabilite' },
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:36', dateCreation: '18/06/2025', dateTraitement: '25/06/2025', delai: 7, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '15:28:55', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '19 340.25 EUR', libelle: 'Commande speciale CS-2025-0089', interlocuteur: 'Michel VINCENT - Commercial' },
        { uid: 'j11045', nom: 'LEROY Anne', reference: '13:37', dateCreation: '22/06/2025', dateTraitement: '28/06/2025', delai: 6, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '11:55:40', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'TECH SOLUTIONS', isin: 'FR0000133308', compteBancaire: 'FR76 3000 4025 6700 0500 0567 890', montant: '34 560.00 EUR', libelle: 'Prestation consulting PC-2025-06', interlocuteur: 'David ROUSSEAU - Consulting' },
    ],
    'Juillet 2025': [
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:38', dateCreation: '01/07/2025', dateTraitement: '04/07/2025', delai: 3, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '08:45:12', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '6 780.00 EUR', libelle: 'Facture juillet FJ-2025-001', interlocuteur: 'Eric BONNET - Comptabilite' },
        { uid: 'j08234', nom: 'MARTIN Jean', reference: '13:39', dateCreation: '05/07/2025', dateTraitement: '09/07/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '10:30:28', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'GROUPE ALPHA', isin: 'FR0000131104', compteBancaire: 'FR76 3000 4025 6700 0200 0456 789', montant: '14 560.50 EUR', libelle: 'Reglement mensuel RM-2025-07', interlocuteur: 'Nathalie HENRY - Tresorerie' },
        { uid: 'j09412', nom: 'BERNARD Sophie', reference: '13:40', dateCreation: '10/07/2025', dateTraitement: '14/07/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '14:20:35', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'FINEXIA', isin: 'FR0000127771', compteBancaire: 'FR76 3000 4025 6700 0300 0789 012', montant: '28 900.00 EUR', libelle: 'Acompte semestre AS-2025-S2', interlocuteur: 'Olivier THOMAS - Direction' },
    ],
    'Aout 2025': [
        { uid: 'j05678', nom: 'PETIT Nicolas', reference: '13:41', dateCreation: '01/08/2025', dateTraitement: '02/08/2025', delai: 1, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '09:12:05', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'BETA INDUSTRIE', isin: 'FR0000125007', compteBancaire: 'FR76 3000 4025 6700 0400 0345 678', montant: '2 340.00 EUR', libelle: 'Urgent cheque UC-2025-0801', interlocuteur: 'Valerie PERRIN - Urgences' },
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:42', dateCreation: '10/08/2025', dateTraitement: '12/08/2025', delai: 2, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '11:45:38', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '5 120.75 EUR', libelle: 'Facture ete FE-2025-08', interlocuteur: 'Bruno CHEVALIER - Comptabilite' },
    ],
    'Septembre 2025': [
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:43', dateCreation: '02/09/2025', dateTraitement: '05/09/2025', delai: 3, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '09:30:15', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '14 780.00 EUR', libelle: 'Rentree septembre RS-2025', interlocuteur: 'Pierre MARTIN - Comptabilite' },
        { uid: 'j08234', nom: 'MARTIN Jean', reference: '13:44', dateCreation: '10/09/2025', dateTraitement: '13/09/2025', delai: 3, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '14:22:08', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'GROUPE ALPHA', isin: 'FR0000131104', compteBancaire: 'FR76 3000 4025 6700 0200 0456 789', montant: '22 450.00 EUR', libelle: 'Trimestre Q3 TQ3-2025', interlocuteur: 'Sophie DURAND - Tresorerie' },
    ],
    'Octobre 2025': [
        { uid: 'j09412', nom: 'BERNARD Sophie', reference: '13:45', dateCreation: '01/10/2025', dateTraitement: '05/10/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '10:15:42', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'FINEXIA', isin: 'FR0000127771', compteBancaire: 'FR76 3000 4025 6700 0300 0789 012', montant: '31 200.00 EUR', libelle: 'Contrat octobre CO-2025', interlocuteur: 'Marc LEFEBVRE - Commercial' },
        { uid: 'j05678', nom: 'PETIT Nicolas', reference: '13:46', dateCreation: '15/10/2025', dateTraitement: '19/10/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '11:50:30', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'BETA INDUSTRIE', isin: 'FR0000125007', compteBancaire: 'FR76 3000 4025 6700 0400 0345 678', montant: '8 670.50 EUR', libelle: 'Facture automne FA-2025-10', interlocuteur: 'Julie MOREAU - Comptabilite' },
    ],
    'Novembre 2025': [
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:47', dateCreation: '03/11/2025', dateTraitement: '07/11/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '09:05:22', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '19 340.00 EUR', libelle: 'Pre-cloture novembre PCN-2025', interlocuteur: 'Thomas GARCIA - Direction' },
        { uid: 'j08234', nom: 'MARTIN Jean', reference: '13:48', dateCreation: '12/11/2025', dateTraitement: '17/11/2025', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '15:40:18', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'GROUPE ALPHA', isin: 'FR0000131104', compteBancaire: 'FR76 3000 4025 6700 0200 0456 789', montant: '45 780.25 EUR', libelle: 'Solde annuel SA-2025', interlocuteur: 'Claire VINCENT - Tresorerie' },
    ],
    'Decembre 2025': [
        { uid: 'j09412', nom: 'BERNARD Sophie', reference: '13:49', dateCreation: '01/12/2025', dateTraitement: '04/12/2025', delai: 3, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '08:45:10', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'FINEXIA', isin: 'FR0000127771', compteBancaire: 'FR76 3000 4025 6700 0300 0789 012', montant: '56 900.00 EUR', libelle: 'Cloture annuelle CL-2025', interlocuteur: 'Philippe ROBERT - Direction' },
        { uid: 'j05678', nom: 'PETIT Nicolas', reference: '13:50', dateCreation: '10/12/2025', dateTraitement: '14/12/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '13:22:45', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'BETA INDUSTRIE', isin: 'FR0000125007', compteBancaire: 'FR76 3000 4025 6700 0400 0345 678', montant: '12 450.75 EUR', libelle: 'Derniere facture DF-2025', interlocuteur: 'Emma SIMON - Comptabilite' },
    ],
    // Donnees 2024
    'Janvier 2024': [
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '12:01', dateCreation: '05/01/2024', dateTraitement: '10/01/2024', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '10:30:22', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '7 890.00 EUR', libelle: 'Facture janvier FJ-2024', interlocuteur: 'Pierre DURAND - Comptabilite' },
        { uid: 'j08234', nom: 'MARTIN Jean', reference: '12:02', dateCreation: '15/01/2024', dateTraitement: '21/01/2024', delai: 6, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '14:15:38', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'GROUPE ALPHA', isin: 'FR0000131104', compteBancaire: 'FR76 3000 4025 6700 0200 0456 789', montant: '18 340.50 EUR', libelle: 'Reglement Q4-2023 RQ4-2023', interlocuteur: 'Marie LEFEBVRE - Tresorerie' },
    ],
    'Juin 2024': [
        { uid: 'j09412', nom: 'BERNARD Sophie', reference: '12:15', dateCreation: '03/06/2024', dateTraitement: '09/06/2024', delai: 6, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '09:45:12', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'FINEXIA', isin: 'FR0000127771', compteBancaire: 'FR76 3000 4025 6700 0300 0789 012', montant: '42 560.00 EUR', libelle: 'Semestre S1-2024', interlocuteur: 'Marc DUVAL - Direction' },
    ],
    'Decembre 2024': [
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '12:30', dateCreation: '02/12/2024', dateTraitement: '08/12/2024', delai: 6, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '11:20:55', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '67 890.00 EUR', libelle: 'Cloture 2024 CL-2024', interlocuteur: 'Thomas GARCIA - Direction Financiere' },
        { uid: 'j08234', nom: 'MARTIN Jean', reference: '12:31', dateCreation: '10/12/2024', dateTraitement: '17/12/2024', delai: 7, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '15:48:30', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'GROUPE ALPHA', isin: 'FR0000131104', compteBancaire: 'FR76 3000 4025 6700 0200 0456 789', montant: '34 560.75 EUR', libelle: 'Solde annuel SA-2024', interlocuteur: 'Claire VINCENT - Tresorerie' },
    ],
    // Donnees 2026
    'Janvier 2026': [
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '14:01', dateCreation: '02/01/2026', dateTraitement: '05/01/2026', delai: 3, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '09:15:10', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '11 230.00 EUR', libelle: 'Ouverture 2026 OUV-2026', interlocuteur: 'Pierre MARTIN - Comptabilite' },
        { uid: 'j09412', nom: 'BERNARD Sophie', reference: '14:02', dateCreation: '08/01/2026', dateTraitement: '11/01/2026', delai: 3, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '14:30:45', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'FINEXIA', isin: 'FR0000127771', compteBancaire: 'FR76 3000 4025 6700 0300 0789 012', montant: '28 670.50 EUR', libelle: 'Premier contrat PC-2026', interlocuteur: 'Sophie DURAND - Commercial' },
    ],
    'Fevrier 2026': [
        { uid: 'j08234', nom: 'MARTIN Jean', reference: '14:03', dateCreation: '03/02/2026', dateTraitement: '06/02/2026', delai: 3, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '10:45:22', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'GROUPE ALPHA', isin: 'FR0000131104', compteBancaire: 'FR76 3000 4025 6700 0200 0456 789', montant: '19 450.00 EUR', libelle: 'Facture fevrier FF-2026', interlocuteur: 'Julie MOREAU - Tresorerie' },
        { uid: 'j05678', nom: 'PETIT Nicolas', reference: '14:04', dateCreation: '05/02/2026', dateTraitement: '09/02/2026', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '11:22:18', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'BETA INDUSTRIE', isin: 'FR0000125007', compteBancaire: 'FR76 3000 4025 6700 0400 0345 678', montant: '8 920.75 EUR', libelle: 'Commande express CE-2026-02', interlocuteur: 'Antoine GIRARD - Logistique' },
    ],
};

// Store all tasks for modal access
let allTasks = [];

function showDetail(mois) {
    // Remove selected class from all bars
    document.querySelectorAll('.bar').forEach(bar => bar.classList.remove('selected'));

    // Add selected class to clicked bar
    event.target.closest('.bar').classList.add('selected');

    // Update title
    document.getElementById('detail-title').textContent = 'Detail des taches - ' + mois + ' (Statut: Traite)';

    // Get data for this month
    const data = testData[mois] || [];

    // Reset allTasks for this month
    allTasks = [];

    // Group data by user
    const userGroups = {};
    data.forEach(row => {
        const userKey = row.uid;
        if (!userGroups[userKey]) {
            userGroups[userKey] = {
                uid: row.uid,
                nom: row.nom,
                service: row.service,
                tasks: []
            };
        }
        userGroups[userKey].tasks.push(row);
    });

    // Build accordion table
    let html = '';
    let groupIndex = 0;

    for (const userKey in userGroups) {
        const user = userGroups[userKey];
        const tasks = user.tasks;

        // Calculate stats
        const nbTaches = tasks.length;
        const delais = tasks.map(t => t.delai);
        const delaiMoyen = (delais.reduce((a, b) => a + b, 0) / nbTaches).toFixed(1);
        const delaiMin = Math.min(...delais);
        const delaiMax = Math.max(...delais);

        // Determine color class for average delay
        let delaiMoyenClass = '';
        if (parseFloat(delaiMoyen) <= 3) delaiMoyenClass = 'delai-court';
        else if (parseFloat(delaiMoyen) <= 5) delaiMoyenClass = 'delai-moyen';
        else delaiMoyenClass = 'delai-long';

        // User summary row (accordion header)
        html += `<tr class="accordion-row" onclick="toggleAccordion(${groupIndex})">
            <td><span class="accordion-icon">&#9654;</span><span class="user-name">${user.nom}</span> (${user.uid})</td>
            <td><span class="stat-badge count">${nbTaches}</span></td>
            <td class="${delaiMoyenClass}">${delaiMoyen} j</td>
            <td>${delaiMin} j</td>
            <td>${delaiMax} j</td>
            <td>${user.service}</td>
        </tr>`;

        // Task detail rows (hidden by default, clickable)
        tasks.forEach((task, taskIndex) => {
            let delaiClass = '';
            if (task.delai <= 3) delaiClass = 'delai-court';
            else if (task.delai <= 5) delaiClass = 'delai-moyen';
            else delaiClass = 'delai-long';

            // Store task index in allTasks
            const taskGlobalIndex = allTasks.length;
            allTasks.push(task);

            html += `<tr class="task-row" data-group="${groupIndex}" onclick="openTaskModal(${taskGlobalIndex})" title="Cliquer pour voir les details">
                <td>&#128269; Ref: ${task.reference}</td>
                <td colspan="2">${task.dateCreation} → ${task.dateTraitement}</td>
                <td colspan="2" class="${delaiClass}">${task.delai} jours</td>
                <td>${task.montant}</td>
            </tr>`;
        });

        groupIndex++;
    }

    document.getElementById('detail-tbody').innerHTML = html;

    // Show container
    document.getElementById('detail-container').classList.add('visible');

    // Scroll to table
    document.getElementById('detail-container').scrollIntoView({ behavior: 'smooth' });
}

function toggleAccordion(groupIndex) {
    // Toggle accordion row expanded state
    const accordionRows = document.querySelectorAll('.accordion-row');
    const clickedRow = accordionRows[groupIndex];
    clickedRow.classList.toggle('expanded');

    // Toggle visibility of task rows
    const taskRows = document.querySelectorAll(`.task-row[data-group="${groupIndex}"]`);
    taskRows.forEach(row => {
        row.classList.toggle('visible');
    });
}

function hideDetail() {
    document.getElementById('detail-container').classList.remove('visible');
    document.querySelectorAll('.bar').forEach(bar => bar.classList.remove('selected'));
}

// Modal functions
function openTaskModal(taskIndex) {
    const task = allTasks[taskIndex];
    if (!task) return;

    // Prevent accordion toggle when clicking task row
    event.stopPropagation();

    // Update modal content
    document.getElementById('modal-title').textContent = 'Detail de la tache - Ref: ' + task.reference;
    document.getElementById('modal-reference').textContent = task.reference;
    document.getElementById('modal-etat').innerHTML = '<span class="status-badge traite">' + task.etat + '</span>';
    document.getElementById('modal-statut').textContent = task.etat;
    document.getElementById('modal-date-creation').textContent = task.dateCreation;
    document.getElementById('modal-date-traitement').textContent = task.dateTraitement;

    // Delai with color
    const delaiEl = document.getElementById('modal-delai');
    delaiEl.textContent = task.delai + ' jours';
    delaiEl.className = 'modal-field-value';
    if (task.delai <= 3) delaiEl.classList.add('success');
    else if (task.delai > 5) delaiEl.classList.add('danger');
    else delaiEl.classList.add('highlight');

    document.getElementById('modal-heure').textContent = task.heure;
    document.getElementById('modal-verrouille').textContent = task.verrouille;
    document.getElementById('modal-type-tache').textContent = task.typeTache;
    document.getElementById('modal-uid').textContent = task.uid;
    document.getElementById('modal-nom').textContent = task.nom;
    document.getElementById('modal-service').textContent = task.service;
    document.getElementById('modal-societe').textContent = task.societe;
    document.getElementById('modal-isin').textContent = task.isin;
    document.getElementById('modal-compte').textContent = task.compteBancaire;
    document.getElementById('modal-montant').textContent = task.montant;
    document.getElementById('modal-libelle').textContent = task.libelle;
    document.getElementById('modal-interlocuteur').textContent = task.interlocuteur;

    // Show modal
    document.getElementById('task-modal').classList.add('visible');
}

function closeTaskModal() {
    document.getElementById('task-modal').classList.remove('visible');
}

function closeModalOnOverlay(event) {
    if (event.target === document.getElementById('task-modal')) {
        closeTaskModal();
    }
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeTaskModal();
        closeSFDModal();
    }
});
</script>

</body>
</html>
