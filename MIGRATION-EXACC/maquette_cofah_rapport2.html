<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>METIER_COFAH_COMPTA - Rapport 2 : Delais de traitement</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
            background-color: #4a5568;
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar gauche */
        .sidebar {
            width: 220px;
            background-color: #f5f5f5;
            border-right: 1px solid #ccc;
            padding: 10px 0;
        }

        .sidebar-item {
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-item:hover {
            background-color: #e8e8e8;
        }

        .sidebar-item.parent {
            font-weight: bold;
        }

        .sidebar-item .icon {
            width: 16px;
            height: 16px;
            display: inline-block;
        }

        .sidebar-item .expand {
            font-size: 10px;
            color: #666;
        }

        /* Indicateurs de couleur */
        .color-box {
            width: 14px;
            height: 14px;
            display: inline-block;
            border: 1px solid #999;
        }

        .color-red { background-color: #dc2626; }
        .color-yellow { background-color: #f59e0b; }
        .color-orange { background-color: #ea580c; }
        .color-green { background-color: #22c55e; }

        .checkbox {
            width: 14px;
            height: 14px;
            border: 1px solid #666;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: white;
            cursor: pointer;
        }

        .checkbox.checked::after {
            content: "\2714";
            font-size: 10px;
            color: #333;
        }

        /* Zone principale */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #f5f0e1;
        }

        /* Barre de menu */
        .menu-bar {
            background: linear-gradient(to bottom, #ff6b35, #e55a2b);
            padding: 8px 15px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .menu-item {
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .menu-item:hover {
            text-decoration: underline;
        }

        .menu-item .arrow {
            font-size: 8px;
        }

        .collapse-btn {
            background: #666;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Titre section */
        .section-title {
            padding: 15px 20px;
            font-size: 14px;
            color: #333;
        }

        /* Container graphique */
        .chart-container {
            padding: 20px;
            background: white;
            margin: 0 20px 20px 20px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .chart-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .chart-title {
            font-size: 14px;
            font-weight: bold;
            color: #f59e0b;
            background-color: #f59e0b;
            color: white;
            padding: 5px 10px;
            display: inline-block;
        }

        .filters {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            color: #333;
            font-weight: 500;
        }

        .filter-group select {
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
            background-color: white;
            cursor: pointer;
        }

        .filter-group select:hover {
            border-color: #999;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #ff6b35;
        }

        /* Graphique barres */
        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 300px;
            padding: 20px 10px;
            border-left: 2px solid #ccc;
            border-bottom: 2px solid #ccc;
            position: relative;
            margin-top: 30px;
        }

        /* Echelle Y */
        .y-axis {
            position: absolute;
            left: -35px;
            top: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
        }

        .bar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 60px;
        }

        .bar {
            width: 45px;
            background-color: #5b7c99;
            border-radius: 3px 3px 0 0;
            position: relative;
            transition: background-color 0.3s;
        }

        .bar:hover {
            background-color: #4a6a85;
        }

        .bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: bold;
            color: #333;
        }

        .bar-label {
            margin-top: 10px;
            font-size: 10px;
            color: #666;
            text-align: center;
            transform: rotate(-45deg);
            white-space: nowrap;
        }

        .chart-description {
            margin-top: 30px;
            font-style: italic;
            color: #333;
            font-size: 13px;
            line-height: 1.5;
        }

        /* Barres cliquables */
        .bar {
            cursor: pointer;
        }

        .bar.selected {
            background-color: #ff6b35 !important;
        }

        /* Tableau detail */
        .detail-container {
            margin-top: 30px;
            display: none;
        }

        .detail-container.visible {
            display: block;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .detail-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            background-color: #5b7c99;
            color: white;
            padding: 5px 10px;
            display: inline-block;
        }

        .close-detail {
            background: #dc2626;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .close-detail:hover {
            background: #b91c1c;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .detail-table th {
            background-color: #e8e4d9;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #ccc;
            color: #333;
        }

        .detail-table td {
            padding: 8px;
            border: 1px solid #ddd;
            color: #333;
        }

        .detail-table tr:nth-child(even) {
            background-color: #fafafa;
        }

        .detail-table tr:hover {
            background-color: #f0f0f0;
        }

        .delai-court {
            color: #22c55e;
            font-weight: bold;
        }

        .delai-moyen {
            color: #f59e0b;
            font-weight: bold;
        }

        .delai-long {
            color: #dc2626;
            font-weight: bold;
        }

        /* Accordion styles */
        .accordion-row {
            cursor: pointer;
            background-color: #f8f9fa !important;
        }

        .accordion-row:hover {
            background-color: #e9ecef !important;
        }

        .accordion-row td:first-child {
            position: relative;
            padding-left: 25px;
        }

        .accordion-icon {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            transition: transform 0.2s;
        }

        .accordion-row.expanded .accordion-icon {
            transform: translateY(-50%) rotate(90deg);
        }

        .task-row {
            display: none;
            background-color: #fff !important;
        }

        .task-row.visible {
            display: table-row;
        }

        .task-row td:first-child {
            padding-left: 40px;
            font-size: 11px;
            color: #666;
        }

        .stat-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }

        .stat-badge.count {
            background-color: #e0e7ff;
            color: #3730a3;
        }

        .user-name {
            font-weight: 600;
        }

        .stats-cell {
            font-size: 11px;
        }

        .legend-container {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 11px;
            color: #666;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-dot.green { background-color: #22c55e; }
        .legend-dot.orange { background-color: #f59e0b; }
        .legend-dot.red { background-color: #dc2626; }

        /* Task row clickable */
        .task-row {
            cursor: pointer;
        }

        .task-row:hover {
            background-color: #e3f2fd !important;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(to bottom, #ff6b35, #e55a2b);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #5b7c99;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #5b7c99;
        }

        .modal-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .modal-field {
            display: flex;
            flex-direction: column;
        }

        .modal-field-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .modal-field-value {
            font-size: 13px;
            color: #333;
            font-weight: 500;
            padding: 8px 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #5b7c99;
        }

        .modal-field-value.highlight {
            background-color: #fff3cd;
            border-left-color: #f59e0b;
        }

        .modal-field-value.success {
            background-color: #d4edda;
            border-left-color: #22c55e;
        }

        .modal-field-value.danger {
            background-color: #f8d7da;
            border-left-color: #dc2626;
        }

        .modal-field.full-width {
            grid-column: span 3;
        }

        .modal-field.half-width {
            grid-column: span 2;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-badge.traite {
            background-color: #ea580c;
            color: white;
        }
    </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
    <div class="sidebar-item parent">
        <span class="expand">></span>
        <span class="checkbox"></span>
        ADC_FINANCE
    </div>

    <div class="sidebar-item parent">
        <span class="expand">v</span>
        <span class="checkbox"></span>
        METIER_COFAH_COMPTA
    </div>

    <div class="sidebar-item" style="padding-left: 35px;">
        <span class="checkbox"></span>
        <span class="color-box color-red"></span>
        Ouverture
    </div>

    <div class="sidebar-item" style="padding-left: 35px;">
        <span class="checkbox"></span>
        <span class="color-box color-yellow"></span>
        Cree
    </div>

    <div class="sidebar-item" style="padding-left: 35px;">
        <span class="checkbox"></span>
        <span class="color-box color-orange"></span>
        A Traiter
    </div>

    <div class="sidebar-item" style="padding-left: 35px;">
        <span class="checkbox checked"></span>
        <span class="color-box color-orange"></span>
        Traite
    </div>

    <div class="sidebar-item" style="padding-left: 35px;">
        <span class="checkbox"></span>
        <span class="color-box color-green"></span>
        Cloture
    </div>

    <div class="sidebar-item parent" style="margin-top: 10px;">
        <span class="expand">></span>
        METIERS
    </div>
</div>

<!-- Main Content -->
<div class="main-content">

    <!-- Menu Bar -->
    <div class="menu-bar">
        <button class="collapse-btn">&lt;</button>
        <div class="menu-item">Cas <span class="arrow">v</span></div>
        <div class="menu-item">Afficher <span class="arrow">v</span></div>
        <div class="menu-item">Exportation <span class="arrow">v</span></div>
    </div>

    <!-- Section Title -->
    <div class="section-title">
        Rapport 2 : Delais de traitement - METIER_COFAH_COMPTA sur les cas Traite
    </div>

    <!-- Chart -->
    <div class="chart-container">
        <div class="chart-header">
            <div class="chart-title">Moyenne Delais de traitement sur les Encaissements CHEQUES</div>
            <div class="filters">
                <div class="filter-group">
                    <label for="filter-annee">Annee :</label>
                    <select id="filter-annee">
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-mois">Mois :</label>
                    <select id="filter-mois">
                        <option value="tous" selected>Tous</option>
                        <option value="01">Janvier</option>
                        <option value="02">Fevrier</option>
                        <option value="03">Mars</option>
                        <option value="04">Avril</option>
                        <option value="05">Mai</option>
                        <option value="06">Juin</option>
                        <option value="07">Juillet</option>
                        <option value="08">Aout</option>
                        <option value="09">Septembre</option>
                        <option value="10">Octobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">Decembre</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="bar-chart">
            <div class="y-axis">
                <span>8.00</span>
                <span>6.00</span>
                <span>4.00</span>
                <span>2.00</span>
                <span>0.00</span>
            </div>

            <div class="bar-item">
                <div class="bar" style="height: 120px;" onclick="showDetail('Janvier 2025')">
                    <span class="bar-value">3.45</span>
                </div>
                <span class="bar-label">janv. 2025</span>
            </div>

            <div class="bar-item">
                <div class="bar" style="height: 160px;" onclick="showDetail('Fevrier 2025')">
                    <span class="bar-value">4.73</span>
                </div>
                <span class="bar-label">fevr. 2025</span>
            </div>

            <div class="bar-item">
                <div class="bar" style="height: 145px;" onclick="showDetail('Mars 2025')">
                    <span class="bar-value">4.14</span>
                </div>
                <span class="bar-label">mars 2025</span>
            </div>

            <div class="bar-item">
                <div class="bar" style="height: 115px;" onclick="showDetail('Avril 2025')">
                    <span class="bar-value">3.36</span>
                </div>
                <span class="bar-label">avr. 2025</span>
            </div>

            <div class="bar-item">
                <div class="bar" style="height: 170px;" onclick="showDetail('Mai 2025')">
                    <span class="bar-value">4.89</span>
                </div>
                <span class="bar-label">mai 2025</span>
            </div>

            <div class="bar-item">
                <div class="bar" style="height: 245px;" onclick="showDetail('Juin 2025')">
                    <span class="bar-value">7.01</span>
                </div>
                <span class="bar-label">juin 2025</span>
            </div>

            <div class="bar-item">
                <div class="bar" style="height: 125px;" onclick="showDetail('Juillet 2025')">
                    <span class="bar-value">3.61</span>
                </div>
                <span class="bar-label">juil. 2025</span>
            </div>

            <div class="bar-item">
                <div class="bar" style="height: 55px;" onclick="showDetail('Aout 2025')">
                    <span class="bar-value">1.28</span>
                </div>
                <span class="bar-label">aout 2025</span>
            </div>
        </div>

        <p class="chart-description">
            Le graphique fait ressortir, une donnee avec un nombre de jours moyen de traitement par mois.
        </p>

        <!-- Detail Table (hidden by default) -->
        <div id="detail-container" class="detail-container">
            <div class="detail-header">
                <span id="detail-title" class="detail-title">Detail des taches - Juin 2025</span>
                <button class="close-detail" onclick="hideDetail()">Fermer</button>
            </div>
            <table class="detail-table">
                <thead>
                    <tr>
                        <th>UID</th>
                        <th>Nb Taches</th>
                        <th>Delai Moyen</th>
                        <th>Delai Min</th>
                        <th>Delai Max</th>
                        <th>Service Correcteur</th>
                    </tr>
                </thead>
                <tbody id="detail-tbody">
                    <!-- Filled by JavaScript - Accordion rows -->
                </tbody>
            </table>
            <div class="legend-container">
                <div class="legend-item"><span class="legend-dot green"></span> Delai <= 3 jours</div>
                <div class="legend-item"><span class="legend-dot orange"></span> Delai 4-5 jours</div>
                <div class="legend-item"><span class="legend-dot red"></span> Delai > 5 jours</div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detail Tache -->
<div id="task-modal" class="modal-overlay" onclick="closeModalOnOverlay(event)">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modal-title">Detail de la tache - Ref: 13:32</h3>
            <button class="modal-close" onclick="closeTaskModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Section Identification -->
            <div class="modal-section">
                <div class="modal-section-title">Identification</div>
                <div class="modal-grid">
                    <div class="modal-field">
                        <span class="modal-field-label">Reference</span>
                        <span class="modal-field-value" id="modal-reference">13:32</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Etat</span>
                        <span class="modal-field-value" id="modal-etat"><span class="status-badge traite">Traite</span></span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Statut Tache</span>
                        <span class="modal-field-value" id="modal-statut">Traite</span>
                    </div>
                </div>
            </div>

            <!-- Section Dates -->
            <div class="modal-section">
                <div class="modal-section-title">Dates et Delais</div>
                <div class="modal-grid">
                    <div class="modal-field">
                        <span class="modal-field-label">Date Ouverture</span>
                        <span class="modal-field-value" id="modal-date-creation">01/06/2025</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Date Traitement</span>
                        <span class="modal-field-value" id="modal-date-traitement">10/06/2025</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Delai (jours)</span>
                        <span class="modal-field-value danger" id="modal-delai">9</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Heure du Deplacement</span>
                        <span class="modal-field-value" id="modal-heure">14:32:45</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Verrouille</span>
                        <span class="modal-field-value" id="modal-verrouille">Non</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Type Taches</span>
                        <span class="modal-field-value" id="modal-type-tache">Encaissement CHEQUE</span>
                    </div>
                </div>
            </div>

            <!-- Section Utilisateur -->
            <div class="modal-section">
                <div class="modal-section-title">Utilisateur / Service</div>
                <div class="modal-grid">
                    <div class="modal-field">
                        <span class="modal-field-label">UID</span>
                        <span class="modal-field-value highlight" id="modal-uid">j07155</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Nom</span>
                        <span class="modal-field-value" id="modal-nom">DUPONT Marie</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Service Correcteur</span>
                        <span class="modal-field-value" id="modal-service">CPTA DFAR FIAB</span>
                    </div>
                </div>
            </div>

            <!-- Section Financier -->
            <div class="modal-section">
                <div class="modal-section-title">Informations Financieres</div>
                <div class="modal-grid">
                    <div class="modal-field">
                        <span class="modal-field-label">Societe</span>
                        <span class="modal-field-value" id="modal-societe">COFAH SA</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">ISIN</span>
                        <span class="modal-field-value" id="modal-isin">FR0000120578</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Compte Bancaire</span>
                        <span class="modal-field-value" id="modal-compte">FR76 3000 4025 6700 0100 0123 456</span>
                    </div>
                    <div class="modal-field">
                        <span class="modal-field-label">Montant Global</span>
                        <span class="modal-field-value highlight" id="modal-montant">12 450.00 EUR</span>
                    </div>
                    <div class="modal-field half-width">
                        <span class="modal-field-label">Libelle</span>
                        <span class="modal-field-value" id="modal-libelle">Encaissement cheque client REF-2025-0632</span>
                    </div>
                </div>
            </div>

            <!-- Section Interlocuteur -->
            <div class="modal-section">
                <div class="modal-section-title">Contact</div>
                <div class="modal-grid">
                    <div class="modal-field full-width">
                        <span class="modal-field-label">Interlocuteur</span>
                        <span class="modal-field-value" id="modal-interlocuteur">Jean-Pierre MARTIN - Direction Financiere</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Donnees de test par mois (avec toutes les colonnes)
const testData = {
    'Janvier 2025': [
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:9', dateCreation: '02/01/2025', dateTraitement: '05/01/2025', delai: 3, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '09:15:32', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '8 250.00 EUR', libelle: 'Encaissement cheque client REF-2025-0109', interlocuteur: 'Pierre DURAND - Comptabilite' },
        { uid: 'j08234', nom: 'MARTIN Jean', reference: '13:11', dateCreation: '10/01/2025', dateTraitement: '14/01/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '11:22:18', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'GROUPE ALPHA', isin: 'FR0000131104', compteBancaire: 'FR76 3000 4025 6700 0200 0456 789', montant: '15 780.50 EUR', libelle: 'Reglement facture F-2025-0234', interlocuteur: 'Marie LEFEBVRE - Tresorerie' },
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:13', dateCreation: '15/01/2025', dateTraitement: '18/01/2025', delai: 3, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '14:45:07', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '3 420.00 EUR', libelle: 'Acompte commande CMD-2025-0089', interlocuteur: 'Luc MOREAU - Direction Financiere' },
        { uid: 'j09412', nom: 'BERNARD Sophie', reference: '13:15', dateCreation: '20/01/2025', dateTraitement: '24/01/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '16:30:55', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'FINEXIA', isin: 'FR0000127771', compteBancaire: 'FR76 3000 4025 6700 0300 0789 012', montant: '22 100.00 EUR', libelle: 'Solde compte client C-4521', interlocuteur: 'Anne ROBERT - Comptabilite Clients' },
    ],
    'Fevrier 2025': [
        { uid: 'j08234', nom: 'MARTIN Jean', reference: '13:17', dateCreation: '01/02/2025', dateTraitement: '06/02/2025', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '08:55:12', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'GROUPE ALPHA', isin: 'FR0000131104', compteBancaire: 'FR76 3000 4025 6700 0200 0456 789', montant: '45 670.00 EUR', libelle: 'Reglement trimestre Q4-2024', interlocuteur: 'Sophie BERNARD - Tresorerie' },
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:19', dateCreation: '05/02/2025', dateTraitement: '09/02/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '10:20:33', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '7 890.25 EUR', libelle: 'Facture F-2025-0412', interlocuteur: 'Jean PETIT - Comptabilite' },
        { uid: 'j05678', nom: 'PETIT Nicolas', reference: '13:20', dateCreation: '12/02/2025', dateTraitement: '17/02/2025', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '13:48:29', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'BETA INDUSTRIE', isin: 'FR0000125007', compteBancaire: 'FR76 3000 4025 6700 0400 0345 678', montant: '18 340.00 EUR', libelle: 'Commande express EXP-2025-0078', interlocuteur: 'Paul GARCIA - Achats' },
    ],
    'Mars 2025': [
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:21', dateCreation: '01/03/2025', dateTraitement: '05/03/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '09:10:45', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '5 600.00 EUR', libelle: 'Avoir client AV-2025-0023', interlocuteur: 'Claire SIMON - Comptabilite' },
        { uid: 'j09412', nom: 'BERNARD Sophie', reference: '13:23', dateCreation: '10/03/2025', dateTraitement: '14/03/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '11:35:18', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'FINEXIA', isin: 'FR0000127771', compteBancaire: 'FR76 3000 4025 6700 0300 0789 012', montant: '31 250.75 EUR', libelle: 'Facture annuelle FA-2025', interlocuteur: 'Marc DUVAL - Direction' },
        { uid: 'j08234', nom: 'MARTIN Jean', reference: '13:24', dateCreation: '15/03/2025', dateTraitement: '20/03/2025', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '15:22:40', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'GROUPE ALPHA', isin: 'FR0000131104', compteBancaire: 'FR76 3000 4025 6700 0200 0456 789', montant: '12 890.00 EUR', libelle: 'Reglement partiel RP-2025-0156', interlocuteur: 'Julie MARTIN - Tresorerie' },
    ],
    'Avril 2025': [
        { uid: 'j05678', nom: 'PETIT Nicolas', reference: '13:25', dateCreation: '02/04/2025', dateTraitement: '05/04/2025', delai: 3, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '08:30:12', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'BETA INDUSTRIE', isin: 'FR0000125007', compteBancaire: 'FR76 3000 4025 6700 0400 0345 678', montant: '9 450.00 EUR', libelle: 'Commande standard CMD-2025-0234', interlocuteur: 'Thomas LEROY - Achats' },
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:27', dateCreation: '08/04/2025', dateTraitement: '12/04/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '14:15:55', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '27 800.50 EUR', libelle: 'Solde exercice SE-2025', interlocuteur: 'Emma BLANC - Direction Financiere' },
    ],
    'Mai 2025': [
        { uid: 'j08234', nom: 'MARTIN Jean', reference: '13:28', dateCreation: '01/05/2025', dateTraitement: '06/05/2025', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '09:45:30', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'GROUPE ALPHA', isin: 'FR0000131104', compteBancaire: 'FR76 3000 4025 6700 0200 0456 789', montant: '16 720.00 EUR', libelle: 'Facture mensuelle FM-2025-05', interlocuteur: 'Nicolas ROUX - Comptabilite' },
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:29', dateCreation: '05/05/2025', dateTraitement: '10/05/2025', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '11:20:18', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '4 560.00 EUR', libelle: 'Acompte projet PRJ-2025-0089', interlocuteur: 'Lucas MOREL - Projets' },
        { uid: 'j09412', nom: 'BERNARD Sophie', reference: '13:30', dateCreation: '12/05/2025', dateTraitement: '17/05/2025', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '14:55:42', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'FINEXIA', isin: 'FR0000127771', compteBancaire: 'FR76 3000 4025 6700 0300 0789 012', montant: '38 900.00 EUR', libelle: 'Contrat annuel CA-2025', interlocuteur: 'Sarah DUPUIS - Commercial' },
        { uid: 'j05678', nom: 'PETIT Nicolas', reference: '13:31', dateCreation: '20/05/2025', dateTraitement: '25/05/2025', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '16:10:05', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'BETA INDUSTRIE', isin: 'FR0000125007', compteBancaire: 'FR76 3000 4025 6700 0400 0345 678', montant: '11 230.75 EUR', libelle: 'Livraison urgente LIV-2025-0412', interlocuteur: 'Antoine GIRARD - Logistique' },
    ],
    'Juin 2025': [
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:32', dateCreation: '01/06/2025', dateTraitement: '10/06/2025', delai: 9, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '14:32:45', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '12 450.00 EUR', libelle: 'Encaissement cheque client REF-2025-0632', interlocuteur: 'Jean-Pierre MARTIN - Direction Financiere' },
        { uid: 'j08234', nom: 'MARTIN Jean', reference: '13:33', dateCreation: '05/06/2025', dateTraitement: '12/06/2025', delai: 7, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '10:18:22', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'GROUPE ALPHA', isin: 'FR0000131104', compteBancaire: 'FR76 3000 4025 6700 0200 0456 789', montant: '23 670.00 EUR', libelle: 'Reglement exceptionnel RX-2025-06', interlocuteur: 'Catherine FAURE - Tresorerie' },
        { uid: 'j09412', nom: 'BERNARD Sophie', reference: '13:34', dateCreation: '10/06/2025', dateTraitement: '18/06/2025', delai: 8, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '09:05:33', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'FINEXIA', isin: 'FR0000127771', compteBancaire: 'FR76 3000 4025 6700 0300 0789 012', montant: '56 780.50 EUR', libelle: 'Investissement projet INV-2025', interlocuteur: 'Philippe LAMBERT - Investissements' },
        { uid: 'j05678', nom: 'PETIT Nicolas', reference: '13:35', dateCreation: '15/06/2025', dateTraitement: '20/06/2025', delai: 5, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '13:42:10', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'BETA INDUSTRIE', isin: 'FR0000125007', compteBancaire: 'FR76 3000 4025 6700 0400 0345 678', montant: '8 920.00 EUR', libelle: 'Facture standard FS-2025-0678', interlocuteur: 'Isabelle MERCIER - Comptabilite' },
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:36', dateCreation: '18/06/2025', dateTraitement: '25/06/2025', delai: 7, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '15:28:55', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '19 340.25 EUR', libelle: 'Commande speciale CS-2025-0089', interlocuteur: 'Michel VINCENT - Commercial' },
        { uid: 'j11045', nom: 'LEROY Anne', reference: '13:37', dateCreation: '22/06/2025', dateTraitement: '28/06/2025', delai: 6, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '11:55:40', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'TECH SOLUTIONS', isin: 'FR0000133308', compteBancaire: 'FR76 3000 4025 6700 0500 0567 890', montant: '34 560.00 EUR', libelle: 'Prestation consulting PC-2025-06', interlocuteur: 'David ROUSSEAU - Consulting' },
    ],
    'Juillet 2025': [
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:38', dateCreation: '01/07/2025', dateTraitement: '04/07/2025', delai: 3, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '08:45:12', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '6 780.00 EUR', libelle: 'Facture juillet FJ-2025-001', interlocuteur: 'Eric BONNET - Comptabilite' },
        { uid: 'j08234', nom: 'MARTIN Jean', reference: '13:39', dateCreation: '05/07/2025', dateTraitement: '09/07/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '10:30:28', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'GROUPE ALPHA', isin: 'FR0000131104', compteBancaire: 'FR76 3000 4025 6700 0200 0456 789', montant: '14 560.50 EUR', libelle: 'Reglement mensuel RM-2025-07', interlocuteur: 'Nathalie HENRY - Tresorerie' },
        { uid: 'j09412', nom: 'BERNARD Sophie', reference: '13:40', dateCreation: '10/07/2025', dateTraitement: '14/07/2025', delai: 4, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '14:20:35', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'FINEXIA', isin: 'FR0000127771', compteBancaire: 'FR76 3000 4025 6700 0300 0789 012', montant: '28 900.00 EUR', libelle: 'Acompte semestre AS-2025-S2', interlocuteur: 'Olivier THOMAS - Direction' },
    ],
    'Aout 2025': [
        { uid: 'j05678', nom: 'PETIT Nicolas', reference: '13:41', dateCreation: '01/08/2025', dateTraitement: '02/08/2025', delai: 1, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '09:12:05', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'BETA INDUSTRIE', isin: 'FR0000125007', compteBancaire: 'FR76 3000 4025 6700 0400 0345 678', montant: '2 340.00 EUR', libelle: 'Urgent cheque UC-2025-0801', interlocuteur: 'Valerie PERRIN - Urgences' },
        { uid: 'j07155', nom: 'DUPONT Marie', reference: '13:42', dateCreation: '10/08/2025', dateTraitement: '12/08/2025', delai: 2, service: 'CPTA DFAR FIAB', etat: 'Traite', heure: '11:45:38', verrouille: 'Non', typeTache: 'Encaissement CHEQUE', societe: 'COFAH SA', isin: 'FR0000120578', compteBancaire: 'FR76 3000 4025 6700 0100 0123 456', montant: '5 120.75 EUR', libelle: 'Facture ete FE-2025-08', interlocuteur: 'Bruno CHEVALIER - Comptabilite' },
    ],
};

// Store all tasks for modal access
let allTasks = [];

function showDetail(mois) {
    // Remove selected class from all bars
    document.querySelectorAll('.bar').forEach(bar => bar.classList.remove('selected'));

    // Add selected class to clicked bar
    event.target.closest('.bar').classList.add('selected');

    // Update title
    document.getElementById('detail-title').textContent = 'Detail des taches - ' + mois + ' (Statut: Traite)';

    // Get data for this month
    const data = testData[mois] || [];

    // Reset allTasks for this month
    allTasks = [];

    // Group data by user
    const userGroups = {};
    data.forEach(row => {
        const userKey = row.uid;
        if (!userGroups[userKey]) {
            userGroups[userKey] = {
                uid: row.uid,
                nom: row.nom,
                service: row.service,
                tasks: []
            };
        }
        userGroups[userKey].tasks.push(row);
    });

    // Build accordion table
    let html = '';
    let groupIndex = 0;

    for (const userKey in userGroups) {
        const user = userGroups[userKey];
        const tasks = user.tasks;

        // Calculate stats
        const nbTaches = tasks.length;
        const delais = tasks.map(t => t.delai);
        const delaiMoyen = (delais.reduce((a, b) => a + b, 0) / nbTaches).toFixed(1);
        const delaiMin = Math.min(...delais);
        const delaiMax = Math.max(...delais);

        // Determine color class for average delay
        let delaiMoyenClass = '';
        if (parseFloat(delaiMoyen) <= 3) delaiMoyenClass = 'delai-court';
        else if (parseFloat(delaiMoyen) <= 5) delaiMoyenClass = 'delai-moyen';
        else delaiMoyenClass = 'delai-long';

        // User summary row (accordion header)
        html += `<tr class="accordion-row" onclick="toggleAccordion(${groupIndex})">
            <td><span class="accordion-icon">&#9654;</span><span class="user-name">${user.nom}</span> (${user.uid})</td>
            <td><span class="stat-badge count">${nbTaches}</span></td>
            <td class="${delaiMoyenClass}">${delaiMoyen} j</td>
            <td>${delaiMin} j</td>
            <td>${delaiMax} j</td>
            <td>${user.service}</td>
        </tr>`;

        // Task detail rows (hidden by default, clickable)
        tasks.forEach((task, taskIndex) => {
            let delaiClass = '';
            if (task.delai <= 3) delaiClass = 'delai-court';
            else if (task.delai <= 5) delaiClass = 'delai-moyen';
            else delaiClass = 'delai-long';

            // Store task index in allTasks
            const taskGlobalIndex = allTasks.length;
            allTasks.push(task);

            html += `<tr class="task-row" data-group="${groupIndex}" onclick="openTaskModal(${taskGlobalIndex})" title="Cliquer pour voir les details">
                <td>&#128269; Ref: ${task.reference}</td>
                <td colspan="2">${task.dateCreation} â†’ ${task.dateTraitement}</td>
                <td colspan="2" class="${delaiClass}">${task.delai} jours</td>
                <td>${task.montant}</td>
            </tr>`;
        });

        groupIndex++;
    }

    document.getElementById('detail-tbody').innerHTML = html;

    // Show container
    document.getElementById('detail-container').classList.add('visible');

    // Scroll to table
    document.getElementById('detail-container').scrollIntoView({ behavior: 'smooth' });
}

function toggleAccordion(groupIndex) {
    // Toggle accordion row expanded state
    const accordionRows = document.querySelectorAll('.accordion-row');
    const clickedRow = accordionRows[groupIndex];
    clickedRow.classList.toggle('expanded');

    // Toggle visibility of task rows
    const taskRows = document.querySelectorAll(`.task-row[data-group="${groupIndex}"]`);
    taskRows.forEach(row => {
        row.classList.toggle('visible');
    });
}

function hideDetail() {
    document.getElementById('detail-container').classList.remove('visible');
    document.querySelectorAll('.bar').forEach(bar => bar.classList.remove('selected'));
}

// Modal functions
function openTaskModal(taskIndex) {
    const task = allTasks[taskIndex];
    if (!task) return;

    // Prevent accordion toggle when clicking task row
    event.stopPropagation();

    // Update modal content
    document.getElementById('modal-title').textContent = 'Detail de la tache - Ref: ' + task.reference;
    document.getElementById('modal-reference').textContent = task.reference;
    document.getElementById('modal-etat').innerHTML = '<span class="status-badge traite">' + task.etat + '</span>';
    document.getElementById('modal-statut').textContent = task.etat;
    document.getElementById('modal-date-creation').textContent = task.dateCreation;
    document.getElementById('modal-date-traitement').textContent = task.dateTraitement;

    // Delai with color
    const delaiEl = document.getElementById('modal-delai');
    delaiEl.textContent = task.delai + ' jours';
    delaiEl.className = 'modal-field-value';
    if (task.delai <= 3) delaiEl.classList.add('success');
    else if (task.delai > 5) delaiEl.classList.add('danger');
    else delaiEl.classList.add('highlight');

    document.getElementById('modal-heure').textContent = task.heure;
    document.getElementById('modal-verrouille').textContent = task.verrouille;
    document.getElementById('modal-type-tache').textContent = task.typeTache;
    document.getElementById('modal-uid').textContent = task.uid;
    document.getElementById('modal-nom').textContent = task.nom;
    document.getElementById('modal-service').textContent = task.service;
    document.getElementById('modal-societe').textContent = task.societe;
    document.getElementById('modal-isin').textContent = task.isin;
    document.getElementById('modal-compte').textContent = task.compteBancaire;
    document.getElementById('modal-montant').textContent = task.montant;
    document.getElementById('modal-libelle').textContent = task.libelle;
    document.getElementById('modal-interlocuteur').textContent = task.interlocuteur;

    // Show modal
    document.getElementById('task-modal').classList.add('visible');
}

function closeTaskModal() {
    document.getElementById('task-modal').classList.remove('visible');
}

function closeModalOnOverlay(event) {
    if (event.target === document.getElementById('task-modal')) {
        closeTaskModal();
    }
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeTaskModal();
    }
});
</script>

</body>
</html>
